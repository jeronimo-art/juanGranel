"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(e,t,n){n.d(t,{$q:function(){return Vc},AK:function(){return _h},Ab:function(){return xh},B$:function(){return Cu},Bt:function(){return Dh},Cf:function(){return Eu},EK:function(){return U},ET:function(){return wh},Eo:function(){return Vu},F8:function(){return tc},Fc:function(){return ju},GL:function(){return bh},IO:function(){return qc},IX:function(){return Ou},Ix:function(){return Qu},JU:function(){return Mu},Jj:function(){return Zu},K9:function(){return b},Ky:function(){return he},L$:function(){return Yu},Lx:function(){return Xc},Lz:function(){return Ju},Me:function(){return Y},Mx:function(){return zu},PL:function(){return dh},PU:function(){return oh},Pb:function(){return Hu},QT:function(){return uh},ST:function(){return Ku},TF:function(){return Wu},TQ:function(){return Hc},UQ:function(){return fh},Ub:function(){return m},W:function(){return Rc},WA:function(){return S},Wi:function(){return wu},Wu:function(){return Jc},Xb:function(){return W},Xk:function(){return lh},Xo:function(){return Gc},ar:function(){return Bc},at:function(){return Du},b9:function(){return jc},cf:function(){return vh},e0:function(){return Wc},fH:function(){return Gu},hJ:function(){return ku},i3:function(){return Sh},iE:function(){return Ru},kl:function(){return hh},l7:function(){return oe},my:function(){return Nu},nP:function(){return Ah},oe:function(){return yh},pl:function(){return gh},qK:function(){return Fc},qY:function(){return Uu},r7:function(){return ph},sc:function(){return Ih},u7:function(){return rh},vh:function(){return zc},vr:function(){return Nh},xU:function(){return Mc},yq:function(){return y},zN:function(){return mh}});var r=n(32238),s=n(8463),i=n(53333),o=n(74444),a=n(43510),u=n(83454);const c="@firebase/firestore";class h{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}h.UNAUTHENTICATED=new h(null),h.GOOGLE_CREDENTIALS=new h("google-credentials-uid"),h.FIRST_PARTY=new h("first-party-uid"),h.MOCK_USER=new h("mock-user");let l="9.6.11";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(w);d.debug(`Firestore (${l}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(w);d.error(`Firestore (${l}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(w);d.warn(`Firestore (${l}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function v(e="Unexpected state"){const t=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function I(e,t){e||v()}function b(e,t){e||v()}function E(e,t){return e}const T={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class _{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class N{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(h.UNAUTHENTICATED)))}shutdown(){}}class x{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class A{constructor(e){this.t=e,this.currentUser=h.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new _;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new _,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new _)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(I("string"==typeof t.accessToken),new D(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return I(null===e||"string"==typeof e),new h(e)}}class k{constructor(e,t,n){this.type="FirstParty",this.user=h.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);const r=e.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class C{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new k(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(h.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class M{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class V{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(e,t){const n=e=>{null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.p;return this.p=e.token,g("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.g.getImmediate({optional:!0});e?r(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(I("string"==typeof e.token),this.p=e.token,new M(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class R{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.I(e),this.T=e=>t.writeSequenceNumber(e))}I(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.T&&this.T(e),e}}function L(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}R.A=-1;class F{static R(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=L(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%e.length))}return n}}function P(e,t){return e<t?-1:e>t?1:0}function O(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function q(e){return e+"\0"}class U{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new S(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return U.fromMillis(Date.now())}static fromDate(e){return U.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new U(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?P(this.nanoseconds,e.nanoseconds):P(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{constructor(e){this.timestamp=e}static fromTimestamp(e){return new B(e)}static min(){return new B(new U(0,0))}static max(){return new B(new U(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function K(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function G(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function $(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class j{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===j.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof j?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class z extends j{construct(e,t,n){return new z(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(T.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new z(t)}static emptyPath(){return new z([])}}const Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends j{construct(e,t,n){return new W(e,t,n)}static isValidIdentifier(e){return Q.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new W(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(T.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new S(T.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(T.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new S(T.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class H{constructor(e){this.fields=e,e.sort(W.comparator)}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return O(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}function Y(){return"undefined"!=typeof atob}class X{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new X(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new X(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return P(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}X.EMPTY_BYTE_STRING=new X("");const J=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Z(e){if(I(!!e),"string"==typeof e){let t=0;const n=J.exec(e);if(I(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ee(e.seconds),nanos:ee(e.nanos)}}function ee(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function te(e){return"string"==typeof e?X.fromBase64String(e):X.fromUint8Array(e)}function ne(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function re(e){const t=e.mapValue.fields.__previous_value__;return ne(t)?re(t):t}function se(e){const t=Z(e.mapValue.fields.__local_write_time__.timestampValue);return new U(t.seconds,t.nanos)}class ie{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class oe{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new oe("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof oe&&e.projectId===this.projectId&&e.database===this.database}}function ae(e){return null==e}function ue(e){return 0===e&&1/e==-1/0}function ce(e){return"number"==typeof e&&Number.isInteger(e)&&!ue(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}class he{constructor(e){this.path=e}static fromPath(e){return new he(z.fromString(e))}static fromName(e){return new he(z.fromString(e).popFirst(5))}static empty(){return new he(z.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===z.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return z.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new he(new z(e.slice()))}}const le={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},de={nullValue:"NULL_VALUE"};function fe(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ne(e)?4:Ne(e)?9:10:v()}function me(e,t){if(e===t)return!0;const n=fe(e);if(n!==fe(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return se(e).isEqual(se(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Z(e.timestampValue),r=Z(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return te(e.bytesValue).isEqual(te(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ee(e.geoPointValue.latitude)===ee(t.geoPointValue.latitude)&&ee(e.geoPointValue.longitude)===ee(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ee(e.integerValue)===ee(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ee(e.doubleValue),r=ee(t.doubleValue);return n===r?ue(n)===ue(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return O(e.arrayValue.values||[],t.arrayValue.values||[],me);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(K(n)!==K(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!me(n[s],r[s])))return!1;return!0}(e,t);default:return v()}}function ge(e,t){return void 0!==(e.values||[]).find((e=>me(e,t)))}function pe(e,t){if(e===t)return 0;const n=fe(e),r=fe(t);if(n!==r)return P(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return P(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ee(e.integerValue||e.doubleValue),r=ee(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return ye(e.timestampValue,t.timestampValue);case 4:return ye(se(e),se(t));case 5:return P(e.stringValue,t.stringValue);case 6:return function(e,t){const n=te(e),r=te(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=P(n[s],r[s]);if(0!==e)return e}return P(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=P(ee(e.latitude),ee(t.latitude));return 0!==n?n:P(ee(e.longitude),ee(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=pe(n[s],r[s]);if(e)return e}return P(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=P(r[o],i[o]);if(0!==e)return e;const t=pe(n[r[o]],s[i[o]]);if(0!==t)return t}return P(r.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function ye(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return P(e,t);const n=Z(e),r=Z(t),s=P(n.seconds,r.seconds);return 0!==s?s:P(n.nanos,r.nanos)}function we(e){return ve(e)}function ve(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Z(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?te(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,he.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=ve(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${ve(e.fields[s])}`;return n+"}"}(e.mapValue):v();var t,n}function Ie(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function be(e){return!!e&&"integerValue"in e}function Ee(e){return!!e&&"arrayValue"in e}function Te(e){return!!e&&"nullValue"in e}function Se(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function _e(e){return!!e&&"mapValue"in e}function De(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return G(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=De(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=De(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Ne(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function xe(e){return"nullValue"in e?de:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Ie(oe.empty(),he.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:v()}function Ae(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Ie(oe.empty(),he.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?le:v()}function ke(e,t){return void 0===e?t:void 0===t||pe(e,t)>0?e:t}function Ce(e,t){return void 0===e?t:void 0===t||pe(e,t)<0?e:t}class Me{constructor(e){this.value=e}static empty(){return new Me({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!_e(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=De(t)}setAll(e){let t=W.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=De(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());_e(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return me(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];_e(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){G(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new Me(De(this.value))}}function Ve(e){const t=[];return G(e.fields,((e,n)=>{const r=new W([e]);if(_e(n)){const e=Ve(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new H(t)}class Re{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new Re(e,0,B.min(),B.min(),Me.empty(),0)}static newFoundDocument(e,t,n){return new Re(e,1,t,B.min(),n,0)}static newNoDocument(e,t){return new Re(e,2,t,B.min(),Me.empty(),0)}static newUnknownDocument(e,t){return new Re(e,3,t,B.min(),Me.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Me.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Me.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Re&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Re(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Le{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Fe(e){return e.fields.find((e=>2===e.kind))}function Pe(e){return e.fields.filter((e=>2!==e.kind))}Le.UNKNOWN_ID=-1;class Oe{constructor(e,t){this.fieldPath=e,this.kind=t}}class qe{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new qe(0,Ke.min())}}function Ue(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=B.fromTimestamp(1e9===r?new U(n+1,0):new U(n,r));return new Ke(s,he.empty(),t)}function Be(e){return new Ke(e.readTime,e.key,-1)}class Ke{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Ke(B.min(),he.empty(),-1)}static max(){return new Ke(B.max(),he.empty(),-1)}}function Ge(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=he.comparator(e.documentKey,t.documentKey),0!==n?n:P(e.largestBatchId,t.largestBatchId))}class $e{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.P=null}}function je(e,t=null,n=[],r=[],s=null,i=null,o=null){return new $e(e,t,n,r,s,i,o)}function ze(e){const t=E(e);if(null===t.P){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>{return(t=e).field.canonicalString()+t.op.toString()+we(t.value);var t})).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),ae(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>we(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>we(e))).join(",")),t.P=e}return t.P}function Qe(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let s=0;s<e.orderBy.length;s++)if(!ct(e.orderBy[s],t.orderBy[s]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(n=e.filters[s],r=t.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!me(n.value,r.value))return!1;var n,r;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!lt(e.startAt,t.startAt)&&lt(e.endAt,t.endAt)}function We(e){return he.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function He(e,t){return e.filters.filter((e=>e instanceof Je&&e.field.isEqual(t)))}function Ye(e,t,n){let r,s=!0;for(const i of He(e,t)){let e,t=!0;switch(i.op){case"<":case"<=":e=xe(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=de}ke(r,e)===e&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];ke(r,e)===e&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function Xe(e,t,n){let r,s=!0;for(const i of He(e,t)){let e,t=!0;switch(i.op){case">=":case">":e=Ae(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=le}Ce(r,e)===e&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Ce(r,e)===e&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class Je extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.V(e,t,n):new Ze(e,t,n):"array-contains"===t?new rt(e,n):"in"===t?new st(e,n):"not-in"===t?new it(e,n):"array-contains-any"===t?new ot(e,n):new Je(e,t,n)}static V(e,t,n){return"in"===t?new et(e,n):new tt(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.v(pe(t,this.value)):null!==t&&fe(this.value)===fe(t)&&this.v(pe(t,this.value))}v(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}S(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Ze extends Je{constructor(e,t,n){super(e,t,n),this.key=he.fromName(n.referenceValue)}matches(e){const t=he.comparator(e.key,this.key);return this.v(t)}}class et extends Je{constructor(e,t){super(e,"in",t),this.keys=nt("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class tt extends Je{constructor(e,t){super(e,"not-in",t),this.keys=nt("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function nt(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>he.fromName(e.referenceValue)))}class rt extends Je{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Ee(t)&&ge(t.arrayValue,this.value)}}class st extends Je{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&ge(this.value.arrayValue,t)}}class it extends Je{constructor(e,t){super(e,"not-in",t)}matches(e){if(ge(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!ge(this.value.arrayValue,t)}}class ot extends Je{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ee(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>ge(this.value.arrayValue,e)))}}class at{constructor(e,t){this.position=e,this.inclusive=t}}class ut{constructor(e,t="asc"){this.field=e,this.dir=t}}function ct(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function ht(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?he.comparator(he.fromName(o.referenceValue),n.key):pe(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function lt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!me(e.position[n],t.position[n]))return!1;return!0}class dt{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.D=null,this.C=null,this.startAt,this.endAt}}function ft(e,t,n,r,s,i,o,a){return new dt(e,t,n,r,s,i,o,a)}function mt(e){return new dt(e)}function gt(e){return!ae(e.limit)&&"F"===e.limitType}function pt(e){return!ae(e.limit)&&"L"===e.limitType}function yt(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function wt(e){for(const t of e.filters)if(t.S())return t.field;return null}function vt(e){return null!==e.collectionGroup}function It(e){const t=E(e);if(null===t.D){t.D=[];const e=wt(t),n=yt(t);if(null!==e&&null===n)e.isKeyField()||t.D.push(new ut(e)),t.D.push(new ut(W.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.D.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.D.push(new ut(W.keyField(),e))}}}return t.D}function bt(e){const t=E(e);if(!t.C)if("F"===t.limitType)t.C=je(t.path,t.collectionGroup,It(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of It(t)){const t="desc"===s.dir?"asc":"desc";e.push(new ut(s.field,t))}const n=t.endAt?new at(t.endAt.position,!t.endAt.inclusive):null,r=t.startAt?new at(t.startAt.position,!t.startAt.inclusive):null;t.C=je(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.C}function Et(e,t,n){return new dt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Tt(e,t){return Qe(bt(e),bt(t))&&e.limitType===t.limitType}function St(e){return`${ze(bt(e))}|lt:${e.limitType}`}function _t(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>{return`${(t=e).field.canonicalString()} ${t.op} ${we(t.value)}`;var t})).join(", ")}]`),ae(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>we(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>we(e))).join(",")),`Target(${t})`}(bt(e))}; limitType=${e.limitType})`}function Dt(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):he.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of e.explicitOrderBy)if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=ht(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,It(e),t))&&!(e.endAt&&!function(e,t,n){const r=ht(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,It(e),t))}(e,t)}function Nt(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function xt(e){return(t,n)=>{let r=!1;for(const s of It(e)){const e=At(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function At(e,t,n){const r=e.field.isKeyField()?he.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?pe(r,s):v()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}function kt(e,t){if(e.N){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ue(t)?"-0":t}}function Ct(e){return{integerValue:""+e}}function Mt(e,t){return ce(t)?Ct(t):kt(e,t)}class Vt{constructor(){this._=void 0}}function Rt(e,t,n){return e instanceof Pt?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof Ot?qt(e,t):e instanceof Ut?Bt(e,t):function(e,t){const n=Ft(e,t),r=Gt(n)+Gt(e.k);return be(n)&&be(e.k)?Ct(r):kt(e.M,r)}(e,t)}function Lt(e,t,n){return e instanceof Ot?qt(e,t):e instanceof Ut?Bt(e,t):n}function Ft(e,t){return e instanceof Kt?be(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class Pt extends Vt{}class Ot extends Vt{constructor(e){super(),this.elements=e}}function qt(e,t){const n=$t(t);for(const r of e.elements)n.some((e=>me(e,r)))||n.push(r);return{arrayValue:{values:n}}}class Ut extends Vt{constructor(e){super(),this.elements=e}}function Bt(e,t){let n=$t(t);for(const r of e.elements)n=n.filter((e=>!me(e,r)));return{arrayValue:{values:n}}}class Kt extends Vt{constructor(e,t){super(),this.M=e,this.k=t}}function Gt(e){return ee(e.integerValue||e.doubleValue)}function $t(e){return Ee(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class jt{constructor(e,t){this.field=e,this.transform=t}}class zt{constructor(e,t){this.version=e,this.transformResults=t}}class Qt{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Qt}static exists(e){return new Qt(void 0,e)}static updateTime(e){return new Qt(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Wt(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Ht{}function Yt(e,t,n){e instanceof tn?function(e,t,n){const r=e.value.clone(),s=sn(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof nn?function(e,t,n){if(!Wt(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=sn(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(rn(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Xt(e,t,n){e instanceof tn?function(e,t,n){if(!Wt(e.precondition,t))return;const r=e.value.clone(),s=on(e.fieldTransforms,n,t);r.setAll(s),t.convertToFoundDocument(en(t),r).setHasLocalMutations()}(e,t,n):e instanceof nn?function(e,t,n){if(!Wt(e.precondition,t))return;const r=on(e.fieldTransforms,n,t),s=t.data;s.setAll(rn(e)),s.setAll(r),t.convertToFoundDocument(en(t),s).setHasLocalMutations()}(e,t,n):function(e,t){Wt(e.precondition,t)&&t.convertToNoDocument(B.min())}(e,t)}function Jt(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=Ft(r.transform,e||null);null!=s&&(null==n&&(n=Me.empty()),n.set(r.field,s))}return n||null}function Zt(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&O(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof Ot&&t instanceof Ot||e instanceof Ut&&t instanceof Ut?O(e.elements,t.elements,me):e instanceof Kt&&t instanceof Kt?me(e.k,t.k):e instanceof Pt&&t instanceof Pt}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}function en(e){return e.isFoundDocument()?e.version:B.min()}class tn extends Ht{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}}class nn extends Ht{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function rn(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function sn(e,t,n){const r=new Map;I(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,Lt(o,a,n[s]))}return r}function on(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,Rt(e,i,t))}return r}class an extends Ht{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}}class un extends Ht{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}}class cn{constructor(e){this.count=e}}var hn,ln;function dn(e){switch(e){default:return v();case T.CANCELLED:case T.UNKNOWN:case T.DEADLINE_EXCEEDED:case T.RESOURCE_EXHAUSTED:case T.INTERNAL:case T.UNAVAILABLE:case T.UNAUTHENTICATED:return!1;case T.INVALID_ARGUMENT:case T.NOT_FOUND:case T.ALREADY_EXISTS:case T.PERMISSION_DENIED:case T.FAILED_PRECONDITION:case T.ABORTED:case T.OUT_OF_RANGE:case T.UNIMPLEMENTED:case T.DATA_LOSS:return!0}}function fn(e){if(void 0===e)return p("GRPC error has no .code"),T.UNKNOWN;switch(e){case hn.OK:return T.OK;case hn.CANCELLED:return T.CANCELLED;case hn.UNKNOWN:return T.UNKNOWN;case hn.DEADLINE_EXCEEDED:return T.DEADLINE_EXCEEDED;case hn.RESOURCE_EXHAUSTED:return T.RESOURCE_EXHAUSTED;case hn.INTERNAL:return T.INTERNAL;case hn.UNAVAILABLE:return T.UNAVAILABLE;case hn.UNAUTHENTICATED:return T.UNAUTHENTICATED;case hn.INVALID_ARGUMENT:return T.INVALID_ARGUMENT;case hn.NOT_FOUND:return T.NOT_FOUND;case hn.ALREADY_EXISTS:return T.ALREADY_EXISTS;case hn.PERMISSION_DENIED:return T.PERMISSION_DENIED;case hn.FAILED_PRECONDITION:return T.FAILED_PRECONDITION;case hn.ABORTED:return T.ABORTED;case hn.OUT_OF_RANGE:return T.OUT_OF_RANGE;case hn.UNIMPLEMENTED:return T.UNIMPLEMENTED;case hn.DATA_LOSS:return T.DATA_LOSS;default:return v()}}(ln=hn||(hn={}))[ln.OK=0]="OK",ln[ln.CANCELLED=1]="CANCELLED",ln[ln.UNKNOWN=2]="UNKNOWN",ln[ln.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ln[ln.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ln[ln.NOT_FOUND=5]="NOT_FOUND",ln[ln.ALREADY_EXISTS=6]="ALREADY_EXISTS",ln[ln.PERMISSION_DENIED=7]="PERMISSION_DENIED",ln[ln.UNAUTHENTICATED=16]="UNAUTHENTICATED",ln[ln.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ln[ln.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ln[ln.ABORTED=10]="ABORTED",ln[ln.OUT_OF_RANGE=11]="OUT_OF_RANGE",ln[ln.UNIMPLEMENTED=12]="UNIMPLEMENTED",ln[ln.INTERNAL=13]="INTERNAL",ln[ln.UNAVAILABLE=14]="UNAVAILABLE",ln[ln.DATA_LOSS=15]="DATA_LOSS";class mn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){G(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return $(this.inner)}size(){return this.innerSize}}class gn{constructor(e,t){this.comparator=e,this.root=t||yn.EMPTY}insert(e,t){return new gn(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,yn.BLACK,null,null))}remove(e){return new gn(this.comparator,this.root.remove(e,this.comparator).copy(null,null,yn.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new pn(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new pn(this.root,e,this.comparator,!1)}getReverseIterator(){return new pn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new pn(this.root,e,this.comparator,!0)}}class pn{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class yn{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:yn.RED,this.left=null!=r?r:yn.EMPTY,this.right=null!=s?s:yn.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new yn(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return yn.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return yn.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,yn.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,yn.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}yn.EMPTY=null,yn.RED=!0,yn.BLACK=!1,yn.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,r,s){return this}insert(e,t,n){return new yn(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class wn{constructor(e){this.comparator=e,this.data=new gn(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new vn(this.data.getIterator())}getIteratorFrom(e){return new vn(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof wn))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new wn(this.comparator);return t.data=e,t}}class vn{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function In(e){return e.hasNext()?e.getNext():void 0}const bn=new gn(he.comparator);function En(){return bn}const Tn=new gn(he.comparator);function Sn(){return Tn}function _n(){return new mn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Dn=new gn(he.comparator),Nn=new wn(he.comparator);function xn(...e){let t=Nn;for(const n of e)t=t.add(n);return t}const An=new wn(P);function kn(){return An}class Cn{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,Mn.createSynthesizedTargetChangeForCurrentChange(e,t)),new Cn(B.min(),n,kn(),En(),xn())}}class Mn{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new Mn(X.EMPTY_BYTE_STRING,t,xn(),xn(),xn())}}class Vn{constructor(e,t,n,r){this.O=e,this.removedTargetIds=t,this.key=n,this.F=r}}class Rn{constructor(e,t){this.targetId=e,this.$=t}}class Ln{constructor(e,t,n=X.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Fn{constructor(){this.B=0,this.L=qn(),this.U=X.EMPTY_BYTE_STRING,this.q=!1,this.K=!0}get current(){return this.q}get resumeToken(){return this.U}get G(){return 0!==this.B}get j(){return this.K}W(e){e.approximateByteSize()>0&&(this.K=!0,this.U=e)}H(){let e=xn(),t=xn(),n=xn();return this.L.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:v()}})),new Mn(this.U,this.q,e,t,n)}J(){this.K=!1,this.L=qn()}Y(e,t){this.K=!0,this.L=this.L.insert(e,t)}X(e){this.K=!0,this.L=this.L.remove(e)}Z(){this.B+=1}tt(){this.B-=1}et(){this.K=!0,this.q=!0}}class Pn{constructor(e){this.nt=e,this.st=new Map,this.it=En(),this.rt=On(),this.ot=new wn(P)}ut(e){for(const t of e.O)e.F&&e.F.isFoundDocument()?this.at(t,e.F):this.ct(t,e.key,e.F);for(const t of e.removedTargetIds)this.ct(t,e.key,e.F)}ht(e){this.forEachTarget(e,(t=>{const n=this.lt(t);switch(e.state){case 0:this.ft(t)&&n.W(e.resumeToken);break;case 1:n.tt(),n.G||n.J(),n.W(e.resumeToken);break;case 2:n.tt(),n.G||this.removeTarget(t);break;case 3:this.ft(t)&&(n.et(),n.W(e.resumeToken));break;case 4:this.ft(t)&&(this.dt(t),n.W(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.st.forEach(((e,n)=>{this.ft(n)&&t(n)}))}_t(e){const t=e.targetId,n=e.$.count,r=this.wt(t);if(r){const e=r.target;if(We(e))if(0===n){const n=new he(e.path);this.ct(t,n,Re.newNoDocument(n,B.min()))}else I(1===n);else this.gt(t)!==n&&(this.dt(t),this.ot=this.ot.add(t))}}yt(e){const t=new Map;this.st.forEach(((n,r)=>{const s=this.wt(r);if(s){if(n.current&&We(s.target)){const t=new he(s.target.path);null!==this.it.get(t)||this.It(r,t)||this.ct(r,t,Re.newNoDocument(t,e))}n.j&&(t.set(r,n.H()),n.J())}}));let n=xn();this.rt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.wt(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.it.forEach(((t,n)=>n.setReadTime(e)));const r=new Cn(e,t,this.ot,this.it,n);return this.it=En(),this.rt=On(),this.ot=new wn(P),r}at(e,t){if(!this.ft(e))return;const n=this.It(e,t.key)?2:0;this.lt(e).Y(t.key,n),this.it=this.it.insert(t.key,t),this.rt=this.rt.insert(t.key,this.Tt(t.key).add(e))}ct(e,t,n){if(!this.ft(e))return;const r=this.lt(e);this.It(e,t)?r.Y(t,1):r.X(t),this.rt=this.rt.insert(t,this.Tt(t).delete(e)),n&&(this.it=this.it.insert(t,n))}removeTarget(e){this.st.delete(e)}gt(e){const t=this.lt(e).H();return this.nt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Z(e){this.lt(e).Z()}lt(e){let t=this.st.get(e);return t||(t=new Fn,this.st.set(e,t)),t}Tt(e){let t=this.rt.get(e);return t||(t=new wn(P),this.rt=this.rt.insert(e,t)),t}ft(e){const t=null!==this.wt(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}wt(e){const t=this.st.get(e);return t&&t.G?null:this.nt.Et(e)}dt(e){this.st.set(e,new Fn),this.nt.getRemoteKeysForTarget(e).forEach((t=>{this.ct(e,t,null)}))}It(e,t){return this.nt.getRemoteKeysForTarget(e).has(t)}}function On(){return new gn(he.comparator)}function qn(){return new gn(he.comparator)}const Un={asc:"ASCENDING",desc:"DESCENDING"},Bn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Kn{constructor(e,t){this.databaseId=e,this.N=t}}function Gn(e,t){return e.N?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function $n(e,t){return e.N?t.toBase64():t.toUint8Array()}function jn(e,t){return Gn(e,t.toTimestamp())}function zn(e){return I(!!e),B.fromTimestamp(function(e){const t=Z(e);return new U(t.seconds,t.nanos)}(e))}function Qn(e,t){return function(e){return new z(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function Wn(e){const t=z.fromString(e);return I(pr(t)),t}function Hn(e,t){return Qn(e.databaseId,t.path)}function Yn(e,t){const n=Wn(t);if(n.get(1)!==e.databaseId.projectId)throw new S(T.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(T.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new he(er(n))}function Xn(e,t){return Qn(e.databaseId,t)}function Jn(e){const t=Wn(e);return 4===t.length?z.emptyPath():er(t)}function Zn(e){return new z(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function er(e){return I(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function tr(e,t,n){return{name:Hn(e,t),fields:n.value.mapValue.fields}}function nr(e,t,n){const r=Yn(e,t.name),s=zn(t.updateTime),i=new Me({mapValue:{fields:t.fields}}),o=Re.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function rr(e,t){let n;if(t instanceof tn)n={update:tr(e,t.key,t.value)};else if(t instanceof an)n={delete:Hn(e,t.key)};else if(t instanceof nn)n={update:tr(e,t.key,t.data),updateMask:gr(t.fieldMask)};else{if(!(t instanceof un))return v();n={verify:Hn(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof Pt)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Ot)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Ut)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Kt)return{fieldPath:t.field.canonicalString(),increment:n.k};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:jn(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function sr(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?Qt.updateTime(zn(e.updateTime)):void 0!==e.exists?Qt.exists(e.exists):Qt.none()}(t.currentDocument):Qt.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)I("REQUEST_TIME"===t.setToServerValue),n=new Pt;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new Ot(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new Ut(e)}else"increment"in t?n=new Kt(e,t.increment):v();const r=W.fromServerFormat(t.fieldPath);return new jt(r,n)}(e,t))):[];if(t.update){t.update.name;const s=Yn(e,t.update.name),i=new Me({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new H(t.map((e=>W.fromServerFormat(e))))}(t.updateMask);return new nn(s,i,e,n,r)}return new tn(s,i,n,r)}if(t.delete){const r=Yn(e,t.delete);return new an(r,n)}if(t.verify){const r=Yn(e,t.verify);return new un(r,n)}return v()}function ir(e,t){return{documents:[Xn(e,t.path)]}}function or(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Xn(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Xn(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0===e.length)return;const t=e.map((e=>function(e){if("=="===e.op){if(Se(e.value))return{unaryFilter:{field:lr(e.field),op:"IS_NAN"}};if(Te(e.value))return{unaryFilter:{field:lr(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Se(e.value))return{unaryFilter:{field:lr(e.field),op:"IS_NOT_NAN"}};if(Te(e.value))return{unaryFilter:{field:lr(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:lr(e.field),op:hr(e.op),value:e.value}}}(e)));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:lr(e.field),direction:cr(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.N||ae(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function ar(e){let t=Jn(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=ur(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new ut(dr(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,ae(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new at(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new at(n,t)}(n.endAt)),ft(t,s,o,i,a,"F",u,c)}function ur(e){return e?void 0!==e.unaryFilter?[mr(e)]:void 0!==e.fieldFilter?[fr(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((e=>ur(e))).reduce(((e,t)=>e.concat(t))):v():[]}function cr(e){return Un[e]}function hr(e){return Bn[e]}function lr(e){return{fieldPath:e.canonicalString()}}function dr(e){return W.fromServerFormat(e.fieldPath)}function fr(e){return Je.create(dr(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}function mr(e){switch(e.unaryFilter.op){case"IS_NAN":const t=dr(e.unaryFilter.field);return Je.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=dr(e.unaryFilter.field);return Je.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=dr(e.unaryFilter.field);return Je.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=dr(e.unaryFilter.field);return Je.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function gr(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function pr(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function yr(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=vr(t)),t=wr(e.get(n),t);return vr(t)}function wr(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function vr(e){return e+"\x01\x01"}function Ir(e){const t=e.length;if(I(t>=2),2===t)return I("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),z.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:v()}i=t+2}return new z(r)}const br=["userId","batchId"];function Er(e,t){return[e,yr(t)]}function Tr(e,t,n){return[e,yr(t),n]}const Sr={},_r=["prefixPath","collectionGroup","readTime","documentId"],Dr=["prefixPath","collectionGroup","documentId"],Nr=["collectionGroup","readTime","prefixPath","documentId"],xr=["canonicalId","targetId"],Ar=["targetId","path"],kr=["path","targetId"],Cr=["collectionId","parent"],Mr=["indexId","uid"],Vr=["uid","sequenceNumber"],Rr=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Lr=["indexId","uid","orderedDocumentKey"],Fr=["userId","collectionPath","documentId"],Pr=["userId","collectionPath","largestBatchId"],Or=["userId","collectionGroup","largestBatchId"],qr=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ur=[...qr,"documentOverlays"],Br=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Kr=[...Br,"indexConfiguration","indexState","indexEntries"],Gr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class $r{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}class jr{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new jr(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof jr?t:jr.resolve(t)}catch(e){return jr.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):jr.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):jr.reject(t)}static resolve(e){return new jr(((t,n)=>{t(e)}))}static reject(e){return new jr(((t,n)=>{n(e)}))}static waitFor(e){return new jr(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=jr.resolve(!1);for(const n of e)t=t.next((e=>e?jr.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}}class zr{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.At=new _,this.transaction.oncomplete=()=>{this.At.resolve()},this.transaction.onabort=()=>{t.error?this.At.reject(new Hr(e,t.error)):this.At.resolve()},this.transaction.onerror=t=>{const n=es(t.target.error);this.At.reject(new Hr(e,n))}}static open(e,t,n,r){try{return new zr(t,e.transaction(r,n))}catch(e){throw new Hr(t,e)}}get Rt(){return this.At.promise}abort(e){e&&this.At.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}Pt(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new Xr(t)}}class Qr{constructor(e,t,n){this.name=e,this.version=t,this.bt=n,12.2===Qr.Vt((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),Jr(window.indexedDB.deleteDatabase(e)).toPromise()}static vt(){if(!(0,o.hl)())return!1;if(Qr.St())return!0;const e=(0,o.z$)(),t=Qr.Vt(e),n=0<t&&t<10,r=Qr.Dt(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static St(){var e;return"undefined"!=typeof u&&"YES"===(null===(e=u.env)||void 0===e?void 0:e.Ct)}static xt(e,t){return e.store(t)}static Vt(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Dt(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Nt(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new Hr(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new S(T.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(T.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Hr(e,r))},r.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.bt.kt(t,r.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.Mt&&(this.db.onversionchange=e=>this.Mt(e)),this.db}Ot(e){this.Mt=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.Nt(e);const t=zr.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.Pt(),e))).catch((e=>(t.abort(e),jr.reject(e)))).toPromise();return i.catch((()=>{})),await t.Rt,i}catch(e){const t="FirebaseError"!==e.name&&i<3;if(g("SimpleDb","Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Wr{constructor(e){this.Ft=e,this.$t=!1,this.Bt=null}get isDone(){return this.$t}get Lt(){return this.Bt}set cursor(e){this.Ft=e}done(){this.$t=!0}Ut(e){this.Bt=e}delete(){return Jr(this.Ft.delete())}}class Hr extends S{constructor(e,t){super(T.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Yr(e){return"IndexedDbTransactionError"===e.name}class Xr{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),Jr(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),Jr(this.store.add(e))}get(e){return Jr(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),Jr(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),Jr(this.store.count())}qt(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.Kt(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new jr(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}Gt(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new jr(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}Qt(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.jt=!1;const r=this.cursor(n);return this.Kt(r,((e,t,n)=>n.delete()))}Wt(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.Kt(r,t)}zt(e){const t=this.cursor({});return new jr(((n,r)=>{t.onerror=e=>{const t=es(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}Kt(e,t){const n=[];return new jr(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new Wr(s),o=t(s.primaryKey,s.value,i);if(o instanceof jr){const e=o.catch((e=>(i.done(),jr.reject(e))));n.push(e)}i.isDone?r():null===i.Lt?s.continue():s.continue(i.Lt)}})).next((()=>jr.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.jt?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Jr(e){return new jr(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=es(e.target.error);n(t)}}))}let Zr=!1;function es(e){const t=Qr.Vt((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Zr||(Zr=!0,setTimeout((()=>{throw e}),0)),e}}return e}class ts extends $r{constructor(e,t){super(),this.Ht=e,this.currentSequenceNumber=t}}function ns(e,t){const n=E(e);return Qr.xt(n.Ht,t)}class rs{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&Yt(t,e,n[r])}}applyToLocalView(e){for(const t of this.baseMutations)t.key.isEqual(e.key)&&Xt(t,e,this.localWriteTime);for(const t of this.mutations)t.key.isEqual(e.key)&&Xt(t,e,this.localWriteTime)}applyToLocalDocumentSet(e){this.mutations.forEach((t=>{const n=e.get(t.key),r=n;this.applyToLocalView(r),n.isValidDocument()||r.convertToNoDocument(B.min())}))}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),xn())}isEqual(e){return this.batchId===e.batchId&&O(this.mutations,e.mutations,((e,t)=>Zt(e,t)))&&O(this.baseMutations,e.baseMutations,((e,t)=>Zt(e,t)))}}class ss{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){I(e.mutations.length===n.length);let r=Dn;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new ss(e,t,n,r)}}class is{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class os{constructor(e,t,n,r,s=B.min(),i=B.min(),o=X.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new os(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new os(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new os(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class as{constructor(e){this.Jt=e}}function us(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:cs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:Hn(e,t.key),fields:t.data.value.mapValue.fields,updateTime:Gn(e,t.version.toTimestamp())}}(e.Jt,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:hs(t.version)};else{if(!t.isUnknownDocument())return v();r.unknownDocument={path:n.path.toArray(),version:hs(t.version)}}return r}function cs(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function hs(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ls(e){const t=new U(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function ds(e,t){const n=(t.baseMutations||[]).map((t=>sr(e.Jt,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>sr(e.Jt,t))),s=U.fromMillis(t.localWriteTimeMs);return new rs(t.batchId,s,n,r)}function fs(e){const t=ls(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?ls(e.lastLimboFreeSnapshotVersion):B.min();let r;var s;return void 0!==e.query.documents?(I(1===(s=e.query).documents.length),r=bt(mt(Jn(s.documents[0])))):r=function(e){return bt(ar(e))}(e.query),new os(r,e.targetId,0,e.lastListenSequenceNumber,t,n,X.fromBase64String(e.resumeToken))}function ms(e,t){const n=hs(t.snapshotVersion),r=hs(t.lastLimboFreeSnapshotVersion);let s;s=We(t.target)?ir(e.Jt,t.target):or(e.Jt,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ze(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function gs(e){const t=ar({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Et(t,t.limit,"L"):t}function ps(e,t){return new is(t.largestBatchId,sr(e.Jt,t.overlayMutation))}function ys(e,t){const n=t.path.lastSegment();return[e,yr(t.path.popLast()),n]}class ws{getBundleMetadata(e,t){return vs(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:ls(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return vs(e).put({bundleId:(n=t).id,createTime:hs(zn(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Is(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:gs(t.bundledQuery),readTime:ls(t.readTime)};var t}))}saveNamedQuery(e,t){return Is(e).put(function(e){return{name:e.name,readTime:hs(zn(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function vs(e){return ns(e,"bundles")}function Is(e){return ns(e,"namedQueries")}class bs{constructor(e,t){this.M=e,this.userId=t}static Yt(e,t){const n=t.uid||"";return new bs(e,n)}getOverlay(e,t){return Es(e).get(ys(this.userId,t)).next((e=>e?ps(this.M,e):null))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new is(t,s);r.push(this.Xt(e,i))})),jr.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(yr(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Es(e).Qt("collectionPathOverlayIndex",r))})),jr.waitFor(s)}getOverlaysForCollection(e,t,n){const r=_n(),s=yr(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Es(e).qt("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=ps(this.M,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=_n();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Es(e).Wt({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=ps(this.M,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}Xt(e,t){return Es(e).put(function(e,t,n){const[r,s,i]=ys(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:rr(e.Jt,n.mutation)}}(this.M,this.userId,t))}}function Es(e){return ns(e,"documentOverlays")}class Ts{constructor(){}Zt(e,t){this.te(e,t),t.ee()}te(e,t){if("nullValue"in e)this.ne(t,5);else if("booleanValue"in e)this.ne(t,10),t.se(e.booleanValue?1:0);else if("integerValue"in e)this.ne(t,15),t.se(ee(e.integerValue));else if("doubleValue"in e){const n=ee(e.doubleValue);isNaN(n)?this.ne(t,13):(this.ne(t,15),ue(n)?t.se(0):t.se(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ne(t,20),"string"==typeof n?t.ie(n):(t.ie(`${n.seconds||""}`),t.se(n.nanos||0))}else if("stringValue"in e)this.re(e.stringValue,t),this.oe(t);else if("bytesValue"in e)this.ne(t,30),t.ue(te(e.bytesValue)),this.oe(t);else if("referenceValue"in e)this.ae(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ne(t,45),t.se(n.latitude||0),t.se(n.longitude||0)}else"mapValue"in e?Ne(e)?this.ne(t,Number.MAX_SAFE_INTEGER):(this.ce(e.mapValue,t),this.oe(t)):"arrayValue"in e?(this.he(e.arrayValue,t),this.oe(t)):v()}re(e,t){this.ne(t,25),this.le(e,t)}le(e,t){t.ie(e)}ce(e,t){const n=e.fields||{};this.ne(t,55);for(const r of Object.keys(n))this.re(r,t),this.te(n[r],t)}he(e,t){const n=e.values||[];this.ne(t,50);for(const r of n)this.te(r,t)}ae(e,t){this.ne(t,37),he.fromName(e).path.forEach((e=>{this.ne(t,60),this.le(e,t)}))}ne(e,t){e.se(t)}oe(e){e.se(2)}}function Ss(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function _s(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=Ss(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}Ts.fe=new Ts;class Ds{constructor(){this.buffer=new Uint8Array(1024),this.position=0}de(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this._e(n.value),n=t.next();this.we()}me(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.ge(n.value),n=t.next();this.ye()}pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this._e(e);else if(e<2048)this._e(960|e>>>6),this._e(128|63&e);else if(t<"\ud800"||"\udbff"<t)this._e(480|e>>>12),this._e(128|63&e>>>6),this._e(128|63&e);else{const e=t.codePointAt(0);this._e(240|e>>>18),this._e(128|63&e>>>12),this._e(128|63&e>>>6),this._e(128|63&e)}}this.we()}Ie(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.ge(e);else if(e<2048)this.ge(960|e>>>6),this.ge(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.ge(480|e>>>12),this.ge(128|63&e>>>6),this.ge(128|63&e);else{const e=t.codePointAt(0);this.ge(240|e>>>18),this.ge(128|63&e>>>12),this.ge(128|63&e>>>6),this.ge(128|63&e)}}this.ye()}Te(e){const t=this.Ee(e),n=_s(t);this.Ae(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Re(e){const t=this.Ee(e),n=_s(t);this.Ae(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Pe(){this.be(255),this.be(255)}Ve(){this.ve(255),this.ve(255)}reset(){this.position=0}seed(e){this.Ae(e.length),this.buffer.set(e,this.position),this.position+=e.length}Se(){return this.buffer.slice(0,this.position)}Ee(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}_e(e){const t=255&e;0===t?(this.be(0),this.be(255)):255===t?(this.be(255),this.be(0)):this.be(t)}ge(e){const t=255&e;0===t?(this.ve(0),this.ve(255)):255===t?(this.ve(255),this.ve(0)):this.ve(e)}we(){this.be(0),this.be(1)}ye(){this.ve(0),this.ve(1)}be(e){this.Ae(1),this.buffer[this.position++]=e}ve(e){this.Ae(1),this.buffer[this.position++]=~e}Ae(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class Ns{constructor(e){this.De=e}ue(e){this.De.de(e)}ie(e){this.De.pe(e)}se(e){this.De.Te(e)}ee(){this.De.Pe()}}class xs{constructor(e){this.De=e}ue(e){this.De.me(e)}ie(e){this.De.Ie(e)}se(e){this.De.Re(e)}ee(){this.De.Ve()}}class As{constructor(){this.De=new Ds,this.Ce=new Ns(this.De),this.xe=new xs(this.De)}seed(e){this.De.seed(e)}Ne(e){return 0===e?this.Ce:this.xe}Se(){return this.De.Se()}reset(){this.De.reset()}}class ks{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}ke(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new ks(this.indexId,this.documentKey,this.arrayValue,n)}}function Cs(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Ms(e.arrayValue,t.arrayValue),0!==n?n:(n=Ms(e.directionalValue,t.directionalValue),0!==n?n:he.comparator(e.documentKey,t.documentKey)))}function Ms(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class Vs{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Me=e.orderBy,this.Oe=[];for(const t of e.filters){const e=t;e.S()?this.Fe=e:this.Oe.push(e)}}$e(e){const t=Fe(e);if(void 0!==t&&!this.Be(t))return!1;const n=Pe(e);let r=0,s=0;for(;r<n.length&&this.Be(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Fe){const e=n[r];if(!this.Le(this.Fe,e)||!this.Ue(this.Me[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Me.length||!this.Ue(this.Me[s++],e))return!1}return!0}Be(e){for(const t of this.Oe)if(this.Le(t,e))return!0;return!1}Le(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}Ue(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class Rs{constructor(){this.qe=new Ls}addToCollectionParentIndex(e,t){return this.qe.add(t),jr.resolve()}getCollectionParents(e,t){return jr.resolve(this.qe.getEntries(t))}addFieldIndex(e,t){return jr.resolve()}deleteFieldIndex(e,t){return jr.resolve()}getDocumentsMatchingTarget(e,t){return jr.resolve(null)}getFieldIndex(e,t){return jr.resolve(null)}getFieldIndexes(e,t){return jr.resolve([])}getNextCollectionGroupToUpdate(e){return jr.resolve(null)}updateCollectionGroup(e,t,n){return jr.resolve()}updateIndexEntries(e,t){return jr.resolve()}}class Ls{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new wn(z.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new wn(z.comparator)).toArray()}}const Fs=new Uint8Array(0);class Ps{constructor(e,t){this.user=e,this.databaseId=t,this.Ke=new Ls,this.Ge=new mn((e=>ze(e)),((e,t)=>Qe(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Ke.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.Ke.add(t)}));const s={collectionId:n,parent:yr(r)};return Os(e).put(s)}return jr.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[q(t),""],!1,!0);return Os(e).qt(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Ir(r.parent))}return n}))}addFieldIndex(e,t){const n=Us(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);return delete r.indexId,n.add(r).next()}deleteFieldIndex(e,t){const n=Us(e),r=Bs(e),s=qs(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=qs(e);let r=!0;const s=new Map;return jr.forEach(this.Qe(t),(t=>this.getFieldIndex(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=xn();const r=[];return jr.forEach(s,((s,i)=>{var o;g("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${ze(t)}`);const a=function(e,t){const n=Fe(t);if(void 0===n)return null;for(const r of He(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),u=function(e,t){const n=new Map;for(const r of Pe(t))for(const t of He(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of Pe(t)){const t=0===s.kind?Ye(e,s.fieldPath,e.startAt):Xe(e,s.fieldPath,e.startAt);if(!t.value)return null;n.push(t.value),r&&(r=t.inclusive)}return new at(n,r)}(i,s),h=function(e,t){const n=[];let r=!0;for(const s of Pe(t)){const t=0===s.kind?Xe(e,s.fieldPath,e.endAt):Ye(e,s.fieldPath,e.endAt);if(!t.value)return null;n.push(t.value),r&&(r=t.inclusive)}return new at(n,r)}(i,s),l=this.je(s,i,c),d=this.je(s,i,h),f=this.We(s,i,u),m=this.ze(s.indexId,a,l,!!c&&c.inclusive,d,!!h&&h.inclusive,f);return jr.forEach(m,(s=>n.Gt(s,t.limit).next((t=>{t.forEach((t=>{const n=he.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return jr.resolve(null)}))}Qe(e){let t=this.Ge.get(e);return t||(t=[e],this.Ge.set(e,t),t)}ze(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(null!=n?n.length:1,null!=s?s.length:1),u=a/(null!=t?t.length:1),c=[];for(let h=0;h<a;++h){const a=t?this.He(t[h/u]):Fs,l=n?this.Je(e,a,n[h%u],r):this.Ye(e),d=s?this.Xe(e,a,s[h%u],i):this.Ye(e+1);c.push(...this.createRange(l,d,o.map((t=>this.Je(e,a,t,!0)))))}return c}Je(e,t,n,r){const s=new ks(e,he.empty(),t,n);return r?s:s.ke()}Xe(e,t,n,r){const s=new ks(e,he.empty(),t,n);return r?s.ke():s}Ye(e){return new ks(e,he.empty(),Fs,Fs)}getFieldIndex(e,t){const n=new Vs(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{const t=e.filter((e=>n.$e(e)));return t.sort(((e,t)=>t.fields.length-e.fields.length)),t.length>0?t[0]:null}))}Ze(e,t){const n=new As;for(const r of Pe(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Ne(r.kind);Ts.fe.Zt(e,s)}return n.Se()}He(e){const t=new As;return Ts.fe.Zt(e,t.Ne(0)),t.Se()}tn(e,t){const n=new As;return Ts.fe.Zt(Ie(this.databaseId,t),n.Ne(function(e){const t=Pe(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Se()}We(e,t,n){if(null===n)return[];let r=[];r.push(new As);let s=0;for(const i of Pe(e)){const e=n[s++];for(const n of r)if(this.en(t,i.fieldPath)&&Ee(e))r=this.nn(r,i,e);else{const t=n.Ne(i.kind);Ts.fe.Zt(e,t)}}return this.sn(r)}je(e,t,n){return null==n?null:this.We(e,t,n.position)}sn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Se();return t}nn(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new As;n.seed(e.Se()),Ts.fe.Zt(i,n.Ne(t.kind)),s.push(n)}return s}en(e,t){return!!e.filters.find((e=>e instanceof Je&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Us(e),r=Bs(e);return(t?n.qt("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.qt()).next((e=>{const t=[];return jr.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new qe(t.sequenceNumber,new Ke(ls(t.readTime),new he(Ir(t.documentKey)),t.largestBatchId)):qe.empty(),r=e.fields.map((([e,t])=>new Oe(W.fromServerFormat(e),t)));return new Le(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:P(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Us(e),s=Bs(e);return this.rn(e).next((e=>r.qt("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>jr.forEach(t,(t=>s.put(function(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:hs(r.readTime),documentKey:yr(r.documentKey.path),largestBatchId:r.largestBatchId}}(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return jr.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?jr.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),jr.forEach(s,(n=>this.on(e,t,n).next((t=>{const s=this.un(r,n);return t.isEqual(s)?jr.resolve():this.an(e,r,n,t,s)})))))))}))}cn(e,t,n,r){return qs(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.tn(n,t.key),documentKey:t.key.path.toArray()})}hn(e,t,n,r){return qs(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.tn(n,t.key),t.key.path.toArray()])}on(e,t,n){const r=qs(e);let s=new wn(Cs);return r.Wt({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.tn(n,t)])},((e,r)=>{s=s.add(new ks(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}un(e,t){let n=new wn(Cs);const r=this.Ze(t,e);if(null==r)return n;const s=Fe(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Ee(i))for(const s of i.arrayValue.values||[])n=n.add(new ks(t.indexId,e.key,this.He(s),r))}else n=n.add(new ks(t.indexId,e.key,Fs,r));return n}an(e,t,n,r,s){g("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=In(i),u=In(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=In(o)):t?(s(a),a=In(i)):(a=In(i),u=In(o))}}(r,s,Cs,(r=>{i.push(this.cn(e,t,n,r))}),(r=>{i.push(this.hn(e,t,n,r))})),jr.waitFor(i)}rn(e){let t=1;return Bs(e).Wt({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>Cs(e,t))).filter(((e,t,n)=>!t||0!==Cs(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=Cs(i,e),s=Cs(i,t);if(0===n)r[0]=e.ke();else if(n>0&&s<0)r.push(i),r.push(i.ke());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2)s.push(IDBKeyRange.bound([r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,Fs,[]],[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,Fs,[]]));return s}}function Os(e){return ns(e,"collectionParents")}function qs(e){return ns(e,"indexEntries")}function Us(e){return ns(e,"indexConfiguration")}function Bs(e){return ns(e,"indexState")}const Ks={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Gs{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Gs(e,Gs.DEFAULT_COLLECTION_PERCENTILE,Gs.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function $s(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Wt({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{I(1===a)})));const c=[];for(const h of n.mutations){const e=Tr(t,h.key.path,n.batchId);i.push(s.delete(e)),c.push(h.key)}return jr.waitFor(i).next((()=>c))}function js(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}Gs.DEFAULT_COLLECTION_PERCENTILE=10,Gs.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Gs.DEFAULT=new Gs(41943040,Gs.DEFAULT_COLLECTION_PERCENTILE,Gs.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Gs.DISABLED=new Gs(-1,0,0);class zs{constructor(e,t,n,r){this.userId=e,this.M=t,this.indexManager=n,this.referenceDelegate=r,this.ln={}}static Yt(e,t,n,r){I(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new zs(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ws(e).Wt({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=Hs(e),i=Ws(e);return i.add({}).next((o=>{I("number"==typeof o);const a=new rs(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map((t=>rr(e.Jt,t))),s=n.mutations.map((t=>rr(e.Jt,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.M,this.userId,a),c=[];let h=new wn(((e,t)=>P(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Tr(this.userId,e.key.path,o);h=h.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,Sr))}return h.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.ln[o]=a.keys()})),jr.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return Ws(e).get(t).next((e=>e?(I(e.userId===this.userId),ds(this.M,e)):null))}fn(e,t){return this.ln[t]?jr.resolve(this.ln[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.ln[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Ws(e).Wt({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(I(t.batchId>=n),s=ds(this.M,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Ws(e).Wt({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ws(e).qt("userMutationsIndex",t).next((e=>e.map((e=>ds(this.M,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Er(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Hs(e).Wt({range:r},((n,r,i)=>{const[o,a,u]=n,c=Ir(a);if(o===this.userId&&t.path.isEqual(c))return Ws(e).get(u).next((e=>{if(!e)throw v();I(e.userId===this.userId),s.push(ds(this.M,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new wn(P);const r=[];return t.forEach((t=>{const s=Er(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Hs(e).Wt({range:i},((e,r,s)=>{const[i,o,a]=e,u=Ir(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),jr.waitFor(r).next((()=>this.dn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Er(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new wn(P);return Hs(e).Wt({range:i},((e,t,s)=>{const[i,a,u]=e,c=Ir(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.dn(e,o)))}dn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Ws(e).get(t).next((e=>{if(null===e)throw v();I(e.userId===this.userId),n.push(ds(this.M,e))})))})),jr.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return $s(e.Ht,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this._n(t.batchId)})),jr.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}_n(e){delete this.ln[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return jr.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return Hs(e).Wt({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Ir(e[1]);r.push(t)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(e,t){return Qs(e,this.userId,t)}wn(e){return Ys(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Qs(e,t,n){const r=Er(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Hs(e).Wt({range:i,jt:!0},((e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function Ws(e){return ns(e,"mutations")}function Hs(e){return ns(e,"documentMutations")}function Ys(e){return ns(e,"mutationQueues")}class Xs{constructor(e){this.mn=e}next(){return this.mn+=2,this.mn}static gn(){return new Xs(0)}static yn(){return new Xs(-1)}}class Js{constructor(e,t){this.referenceDelegate=e,this.M=t}allocateTargetId(e){return this.pn(e).next((t=>{const n=new Xs(t.highestTargetId);return t.highestTargetId=n.next(),this.In(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.pn(e).next((e=>B.fromTimestamp(new U(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.pn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.pn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.In(e,r))))}addTargetData(e,t){return this.Tn(e,t).next((()=>this.pn(e).next((n=>(n.targetCount+=1,this.En(t,n),this.In(e,n))))))}updateTargetData(e,t){return this.Tn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Zs(e).delete(t.targetId))).next((()=>this.pn(e))).next((t=>(I(t.targetCount>0),t.targetCount-=1,this.In(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Zs(e).Wt(((i,o)=>{const a=fs(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>jr.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Zs(e).Wt(((e,n)=>{const r=fs(n);t(r)}))}pn(e){return ei(e).get("targetGlobalKey").next((e=>(I(null!==e),e)))}In(e,t){return ei(e).put("targetGlobalKey",t)}Tn(e,t){return Zs(e).put(ms(this.M,t))}En(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.pn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=ze(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Zs(e).Wt({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=fs(n);Qe(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=ti(e);return t.forEach((t=>{const i=yr(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),jr.waitFor(r)}removeMatchingKeys(e,t,n){const r=ti(e);return jr.forEach(t,(t=>{const s=yr(t.path);return jr.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=ti(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ti(e);let s=xn();return r.Wt({range:n,jt:!0},((e,t,n)=>{const r=Ir(e[1]),i=new he(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=yr(t.path),r=IDBKeyRange.bound([n],[q(n)],!1,!0);let s=0;return ti(e).Wt({index:"documentTargetsIndex",jt:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}Et(e,t){return Zs(e).get(t).next((e=>e?fs(e):null))}}function Zs(e){return ns(e,"targets")}function ei(e){return ns(e,"targetGlobal")}function ti(e){return ns(e,"targetDocuments")}async function ni(e){if(e.code!==T.FAILED_PRECONDITION||e.message!==Gr)throw e;g("LocalStore","Unexpectedly lost primary lease")}function ri([e,t],[n,r]){const s=P(e,n);return 0===s?P(t,r):s}class si{constructor(e){this.An=e,this.buffer=new wn(ri),this.Rn=0}Pn(){return++this.Rn}bn(e){const t=[e,this.Pn()];if(this.buffer.size<this.An)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();ri(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class ii{constructor(e,t){this.garbageCollector=e,this.asyncQueue=t,this.Vn=!1,this.vn=null}start(e){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Sn(e)}stop(){this.vn&&(this.vn.cancel(),this.vn=null)}get started(){return null!==this.vn}Sn(e){const t=this.Vn?3e5:6e4;g("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.vn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.vn=null,this.Vn=!0;try{await e.collectGarbage(this.garbageCollector)}catch(e){Yr(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ni(e)}await this.Sn(e)}))}}class oi{constructor(e,t){this.Dn=e,this.params=t}calculateTargetCount(e,t){return this.Dn.Cn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return jr.resolve(R.A);const n=new si(t);return this.Dn.forEachTarget(e,(e=>n.bn(e.sequenceNumber))).next((()=>this.Dn.xn(e,(e=>n.bn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.Dn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Dn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),jr.resolve(Ks)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ks):this.Nn(e,t)))}getCacheSize(e){return this.Dn.getCacheSize(e)}Nn(e,t){let n,r,s,o,a,u,c;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),jr.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}class ai{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new oi(e,t)}(this,t)}Cn(e){const t=this.kn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}kn(e){let t=0;return this.xn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}xn(e,t){return this.Mn(e,((e,n)=>t(n)))}addReference(e,t,n){return ui(e,n)}removeReference(e,t,n){return ui(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return ui(e,t)}On(e,t){return function(e,t){let n=!1;return Ys(e).zt((r=>Qs(e,r,t).next((e=>(e&&(n=!0),jr.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Mn(e,((i,o)=>{if(o<=t){const t=this.On(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,B.min()),ti(e).delete([0,yr(i.path)]))))}));r.push(t)}})).next((()=>jr.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return ui(e,t)}Mn(e,t){const n=ti(e);let r,s=R.A;return n.Wt({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==R.A&&t(new he(Ir(r)),s),s=o,r=i):s=R.A})).next((()=>{s!==R.A&&t(new he(Ir(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function ui(e,t){return ti(e).put(function(e,t){return{targetId:0,path:yr(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class ci{constructor(){this.changes=new mn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Re.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?jr.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class hi{constructor(e){this.M=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return fi(e).put(n)}removeEntry(e,t,n){return fi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],cs(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Fn(e,n))))}getEntry(e,t){let n=Re.newInvalidDocument(t);return fi(e).Wt({index:"documentKeyIndex",range:IDBKeyRange.only(mi(t))},((e,r)=>{n=this.$n(t,r)})).next((()=>n))}Bn(e,t){let n={size:0,document:Re.newInvalidDocument(t)};return fi(e).Wt({index:"documentKeyIndex",range:IDBKeyRange.only(mi(t))},((e,r)=>{n={document:this.$n(t,r),size:js(r)}})).next((()=>n))}getEntries(e,t){let n=En();return this.Ln(e,t,((e,t)=>{const r=this.$n(e,t);n=n.insert(e,r)})).next((()=>n))}Un(e,t){let n=En(),r=new gn(he.comparator);return this.Ln(e,t,((e,t)=>{const s=this.$n(e,t);n=n.insert(e,s),r=r.insert(e,js(t))})).next((()=>({documents:n,qn:r})))}Ln(e,t,n){if(t.isEmpty())return jr.resolve();let r=new wn(pi);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(mi(r.first()),mi(r.last())),i=r.getIterator();let o=i.getNext();return fi(e).Wt({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=he.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&pi(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.Ut(mi(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(e,t,n){const r=[t.popLast().toArray(),t.lastSegment(),cs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],s=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return fi(e).qt(IDBKeyRange.bound(r,s,!0)).next((e=>{let t=En();for(const n of e){const e=this.$n(he.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t}))}getAllFromCollectionGroup(e,t,n,r){let s=En();const i=gi(t,n),o=gi(t,Ke.max());return fi(e).Wt({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.$n(he.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new li(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return di(e).get("remoteDocumentGlobalKey").next((e=>(I(!!e),e)))}Fn(e,t){return di(e).put("remoteDocumentGlobalKey",t)}$n(e,t){if(t){const e=function(e,t){let n;if(t.document)n=nr(e.Jt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=he.fromSegments(t.noDocument.path),r=ls(t.noDocument.readTime);n=Re.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return v();{const e=he.fromSegments(t.unknownDocument.path),r=ls(t.unknownDocument.version);n=Re.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new U(e[0],e[1]);return B.fromTimestamp(t)}(t.readTime)),n}(this.M,t);if(!e.isNoDocument()||!e.version.isEqual(B.min()))return e}return Re.newInvalidDocument(e)}}class li extends ci{constructor(e,t){super(),this.Kn=e,this.trackRemovals=t,this.Gn=new mn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new wn(((e,t)=>P(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Gn.get(s);if(t.push(this.Kn.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=us(this.Kn.M,i);r=r.add(s.path.popLast());const u=js(a);n+=u-o.size,t.push(this.Kn.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=us(this.Kn.M,i.convertToNoDocument(B.min()));t.push(this.Kn.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.Kn.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.Kn.updateMetadata(e,n)),jr.waitFor(t)}getFromCache(e,t){return this.Kn.Bn(e,t).next((e=>(this.Gn.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.Kn.Un(e,t).next((({documents:e,qn:t})=>(t.forEach(((t,n)=>{this.Gn.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function di(e){return ns(e,"remoteDocumentGlobal")}function fi(e){return ns(e,"remoteDocumentsV14")}function mi(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function gi(e,t){const n=t.documentKey.path.toArray();return[e,cs(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function pi(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=P(n[i],r[i]),s)return s;return s=P(n.length,r.length),s||(s=P(n[n.length-2],r[r.length-2]),s||P(n[n.length-1],r[r.length-1]))}class yi{constructor(e){this.M=e}kt(e,t,n,r){const s=new zr("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",br,{unique:!0}),e.createObjectStore("documentMutations")}(e),wi(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=jr.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),wi(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").qt().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",br,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return jr.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Qn(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.jn(s))))),n<7&&r>=7&&(i=i.next((()=>this.Wn(s)))),n<8&&r>=8&&(i=i.next((()=>this.zn(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.Hn(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Fr});t.createIndex("collectionPathOverlayIndex",Pr,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Or,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:_r});t.createIndex("documentKeyIndex",Dr),t.createIndex("collectionGroupIndex",Nr)}(e))).next((()=>this.Jn(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>{!function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Mr}).createIndex("sequenceNumberIndex",Vr,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Rr}).createIndex("documentKeyIndex",Lr,{unique:!1})}(e)}))),i}jn(e){let t=0;return e.store("remoteDocuments").Wt(((e,n)=>{t+=js(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Qn(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.qt().next((t=>jr.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.qt("userMutationsIndex",r).next((n=>jr.forEach(n,(n=>{I(n.userId===t.userId);const r=ds(this.M,n);return $s(e,t.userId,r).next((()=>{}))}))))}))))}Wn(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.Wt(((n,s)=>{const i=new z(n),o=function(e){return[0,yr(e)]}(i);r.push(t.get(o).next((n=>n?jr.resolve():(n=>t.put({targetId:0,path:yr(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>jr.waitFor(r)))}))}zn(e,t){e.createObjectStore("collectionParents",{keyPath:Cr});const n=t.store("collectionParents"),r=new Ls,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:yr(r)})}};return t.store("remoteDocuments").Wt({jt:!0},((e,t)=>{const n=new z(e);return s(n.popLast())})).next((()=>t.store("documentMutations").Wt({jt:!0},(([e,t,n],r)=>{const i=Ir(t);return s(i.popLast())}))))}Hn(e){const t=e.store("targets");return t.Wt(((e,n)=>{const r=fs(n),s=ms(this.M,r);return t.put(s)}))}Jn(e,t){const n=t.store("remoteDocuments"),r=[];return n.Wt(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=(o=n,o.document?new he(z.fromString(o.document.name).popFirst(5)):o.noDocument?he.fromSegments(o.noDocument.path):o.unknownDocument?he.fromSegments(o.unknownDocument.path):v()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>jr.waitFor(r)))}}function wi(e){e.createObjectStore("targetDocuments",{keyPath:Ar}).createIndex("documentTargetsIndex",kr,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",xr,{unique:!0}),e.createObjectStore("targetGlobal")}const vi="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Ii{constructor(e,t,n,r,s,i,o,a,u,c,h=13){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Yn=s,this.window=i,this.document=o,this.Xn=u,this.Zn=c,this.ts=h,this.es=null,this.ns=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ss=null,this.inForeground=!1,this.rs=null,this.os=null,this.us=Number.NEGATIVE_INFINITY,this.cs=e=>Promise.resolve(),!Ii.vt())throw new S(T.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ai(this,r),this.hs=t+"main",this.M=new as(a),this.ls=new Qr(this.hs,this.ts,new yi(this.M)),this.fs=new Js(this.referenceDelegate,this.M),this.ds=function(e){return new hi(e)}(this.M),this._s=new ws,this.window&&this.window.localStorage?this.ws=this.window.localStorage:(this.ws=null,!1===c&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.gs().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(T.FAILED_PRECONDITION,vi);return this.ys(),this.ps(),this.Is(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.fs.getHighestSequenceNumber(e)))})).then((e=>{this.es=new R(e,this.Xn)})).then((()=>{this.ns=!0})).catch((e=>(this.ls&&this.ls.close(),Promise.reject(e))))}Ts(e){return this.cs=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.ls.Ot((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Yn.enqueueAndForget((async()=>{this.started&&await this.gs()})))}gs(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Ei(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Es(e).next((e=>{e||(this.isPrimary=!1,this.Yn.enqueueRetryable((()=>this.cs(!1))))}))})).next((()=>this.As(e))).next((t=>this.isPrimary&&!t?this.Rs(e).next((()=>!1)):!!t&&this.Ps(e).next((()=>!0)))))).catch((e=>{if(Yr(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.Yn.enqueueRetryable((()=>this.cs(e))),this.isPrimary=e}))}Es(e){return bi(e).get("owner").next((e=>jr.resolve(this.bs(e))))}Vs(e){return Ei(e).delete(this.clientId)}async vs(){if(this.isPrimary&&!this.Ss(this.us,18e5)){this.us=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=ns(e,"clientMetadata");return t.qt().next((e=>{const n=this.Ds(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return jr.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.ws)for(const t of e)this.ws.removeItem(this.Cs(t.clientId))}}Is(){this.os=this.Yn.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.gs().then((()=>this.vs())).then((()=>this.Is()))))}bs(e){return!!e&&e.ownerId===this.clientId}As(e){return this.Zn?jr.resolve(!0):bi(e).get("owner").next((t=>{if(null!==t&&this.Ss(t.leaseTimestampMs,5e3)&&!this.xs(t.ownerId)){if(this.bs(t)&&this.networkEnabled)return!0;if(!this.bs(t)){if(!t.allowTabSynchronization)throw new S(T.FAILED_PRECONDITION,vi);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ei(e).qt().next((e=>void 0===this.Ds(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.ns=!1,this.Ns(),this.os&&(this.os.cancel(),this.os=null),this.ks(),this.Ms(),await this.ls.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new ts(e,R.A);return this.Rs(t).next((()=>this.Vs(t)))})),this.ls.close(),this.Os()}Ds(e,t){return e.filter((e=>this.Ss(e.updateTimeMs,t)&&!this.xs(e.clientId)))}Fs(){return this.runTransaction("getActiveClients","readonly",(e=>Ei(e).qt().next((e=>this.Ds(e,18e5).map((e=>e.clientId))))))}get started(){return this.ns}getMutationQueue(e,t){return zs.Yt(e,this.M,t,this.referenceDelegate)}getTargetCache(){return this.fs}getRemoteDocumentCache(){return this.ds}getIndexManager(e){return new Ps(e,this.M.Jt.databaseId)}getDocumentOverlayCache(e){return bs.Yt(this.M,e)}getBundleCache(){return this._s}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=14===(i=this.ts)?Kr:13===i?Br:12===i?Ur:11===i?qr:void v();var i;let o;return this.ls.runTransaction(e,r,s,(r=>(o=new ts(r,this.es?this.es.next():R.A),"readwrite-primary"===t?this.Es(o).next((e=>!!e||this.As(o))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Yn.enqueueRetryable((()=>this.cs(!1))),new S(T.FAILED_PRECONDITION,Gr);return n(o)})).next((e=>this.Ps(o).next((()=>e)))):this.$s(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}$s(e){return bi(e).get("owner").next((e=>{if(null!==e&&this.Ss(e.leaseTimestampMs,5e3)&&!this.xs(e.ownerId)&&!this.bs(e)&&!(this.Zn||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(T.FAILED_PRECONDITION,vi)}))}Ps(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return bi(e).put("owner",t)}static vt(){return Qr.vt()}Rs(e){const t=bi(e);return t.get("owner").next((e=>this.bs(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):jr.resolve()))}Ss(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(p(`Detected an update time that is in the future: ${e} > ${n}`),!1))}ys(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.rs=()=>{this.Yn.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.gs())))},this.document.addEventListener("visibilitychange",this.rs),this.inForeground="visible"===this.document.visibilityState)}ks(){this.rs&&(this.document.removeEventListener("visibilitychange",this.rs),this.rs=null)}ps(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ss=()=>{this.Ns(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Yn.enterRestrictedMode(!0),this.Yn.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ss))}Ms(){this.ss&&(this.window.removeEventListener("pagehide",this.ss),this.ss=null)}xs(e){var t;try{const n=null!==(null===(t=this.ws)||void 0===t?void 0:t.getItem(this.Cs(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ns(){if(this.ws)try{this.ws.setItem(this.Cs(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}Os(){if(this.ws)try{this.ws.removeItem(this.Cs(this.clientId))}catch(e){}}Cs(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function bi(e){return ns(e,"owner")}function Ei(e){return ns(e,"clientMetadata")}function Ti(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Si{constructor(e,t,n){this.ds=e,this.Bs=t,this.indexManager=n}Ls(e,t){return this.Bs.getAllMutationBatchesAffectingDocumentKey(e,t).next((n=>this.Us(e,t,n)))}Us(e,t,n){return this.ds.getEntry(e,t).next((e=>{for(const t of n)t.applyToLocalView(e);return e}))}qs(e,t){e.forEach(((e,n)=>{for(const r of t)r.applyToLocalView(n)}))}Ks(e,t){return this.ds.getEntries(e,t).next((t=>this.Gs(e,t).next((()=>t))))}Gs(e,t){return this.Bs.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>this.qs(t,e)))}Qs(e,t,n){return function(e){return he.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.js(e,t.path):vt(t)?this.Ws(e,t,n):this.zs(e,t,n)}js(e,t){return this.Ls(e,new he(t)).next((e=>{let t=Sn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}Ws(e,t,n){const r=t.collectionGroup;let s=Sn();return this.indexManager.getCollectionParents(e,r).next((i=>jr.forEach(i,(i=>{const o=function(e,t){return new dt(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.zs(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}zs(e,t,n){let r;return this.ds.getAllFromCollection(e,t.path,n).next((n=>(r=n,this.Bs.getAllMutationBatchesAffectingQuery(e,t)))).next((e=>{for(const t of e)for(const e of t.mutations){const n=e.key;let s=r.get(n);null==s&&(s=Re.newInvalidDocument(n),r=r.insert(n,s)),Xt(e,s,t.localWriteTime),s.isFoundDocument()||(r=r.remove(n))}})).next((()=>(r.forEach(((e,n)=>{Dt(t,n)||(r=r.remove(e))})),r)))}}class _i{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Hs=n,this.Js=r}static Ys(e,t){let n=xn(),r=xn();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new _i(e,t.fromCache,n,r)}}class Di{Xs(e){this.Zs=e}Qs(e,t,n,r){return function(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}(t)||n.isEqual(B.min())?this.ti(e,t):this.Zs.Ks(e,r).next((s=>{const o=this.ei(t,s);return(gt(t)||pt(t))&&this.ni(t.limitType,o,r,n)?this.ti(e,t):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),_t(t)),this.Zs.Qs(e,t,Ue(n,-1)).next((e=>(o.forEach((t=>{e=e.insert(t.key,t)})),e))))}))}ei(e,t){let n=new wn(xt(e));return t.forEach(((t,r)=>{Dt(e,r)&&(n=n.add(r))})),n}ni(e,t,n,r){if(n.size!==t.size)return!0;const s="F"===e?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}ti(e,t){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",_t(t)),this.Zs.Qs(e,t,Ke.min())}}class Ni{constructor(e,t,n,r){this.persistence=e,this.si=t,this.M=r,this.ii=new gn(P),this.ri=new mn((e=>ze(e)),Qe),this.oi=new Map,this.ui=e.getRemoteDocumentCache(),this.fs=e.getTargetCache(),this._s=e.getBundleCache(),this.ai(n)}ai(e){this.indexManager=this.persistence.getIndexManager(e),this.Bs=this.persistence.getMutationQueue(e,this.indexManager),this.ci=new Si(this.ui,this.Bs,this.indexManager),this.ui.setIndexManager(this.indexManager),this.si.Xs(this.ci)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ii)))}}function xi(e,t,n,r){return new Ni(e,t,n,r)}async function Ai(e,t){const n=E(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.Bs.getAllMutationBatches(e).next((s=>(r=s,n.ai(t),n.Bs.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=xn();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.ci.Ks(e,o).next((e=>({hi:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function ki(e){const t=E(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.fs.getLastRemoteSnapshotVersion(e)))}function Ci(e,t,n){let r=xn();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=En();return n.forEach(((n,s)=>{const i=e.get(n);s.isNoDocument()&&s.version.isEqual(B.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!i.isValidDocument()||s.version.compareTo(i.version)>0||0===s.version.compareTo(i.version)&&i.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",i.version," Watch version:",s.version)})),r}))}function Mi(e,t){const n=E(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.Bs.getNextMutationBatchAfterBatchId(e,t))))}function Vi(e,t){const n=E(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.fs.getTargetData(e,t).next((s=>s?(r=s,jr.resolve(r)):n.fs.allocateTargetId(e).next((s=>(r=new os(t,s,0,e.currentSequenceNumber),n.fs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.ii.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ii=n.ii.insert(e.targetId,e),n.ri.set(t,e.targetId)),e}))}async function Ri(e,t,n){const r=E(e),s=r.ii.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!Yr(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ii=r.ii.remove(t),r.ri.delete(s.target)}function Li(e,t,n){const r=E(e);let s=B.min(),i=xn();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=E(e),s=r.ri.get(n);return void 0!==s?jr.resolve(r.ii.get(s)):r.fs.getTargetData(t,n)}(r,e,bt(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.fs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.si.Qs(e,t,n?s:B.min(),n?i:xn()))).next((e=>(Oi(r,Nt(t),e),{documents:e,li:i})))))}function Fi(e,t){const n=E(e),r=E(n.fs),s=n.ii.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.Et(e,t).next((e=>e?e.target:null))))}function Pi(e,t){const n=E(e),r=n.oi.get(t)||B.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.ui.getAllFromCollectionGroup(e,t,Ue(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Oi(n,t,e),e)))}function Oi(e,t,n){let r=B.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.oi.set(t,r)}async function qi(e,t,n=xn()){const r=await Vi(e,bt(gs(t.bundledQuery))),s=E(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=zn(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s._s.saveNamedQuery(e,t);const o=r.withResumeToken(X.EMPTY_BYTE_STRING,i);return s.ii=s.ii.insert(o.targetId,o),s.fs.updateTargetData(e,o).next((()=>s.fs.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.fs.addMatchingKeys(e,n,r.targetId))).next((()=>s._s.saveNamedQuery(e,t)))}))}class Ui{constructor(e){this.M=e,this.wi=new Map,this.mi=new Map}getBundleMetadata(e,t){return jr.resolve(this.wi.get(t))}saveBundleMetadata(e,t){var n;return this.wi.set(t.id,{id:(n=t).id,version:n.version,createTime:zn(n.createTime)}),jr.resolve()}getNamedQuery(e,t){return jr.resolve(this.mi.get(t))}saveNamedQuery(e,t){return this.mi.set(t.name,function(e){return{name:e.name,query:gs(e.bundledQuery),readTime:zn(e.readTime)}}(t)),jr.resolve()}}class Bi{constructor(){this.overlays=new gn(he.comparator),this.gi=new Map}getOverlay(e,t){return jr.resolve(this.overlays.get(t))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.Xt(e,t,r)})),jr.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.gi.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.gi.delete(n)),jr.resolve()}getOverlaysForCollection(e,t,n){const r=_n(),s=t.length+1,i=new he(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return jr.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new gn(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=_n(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=_n(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return jr.resolve(o)}Xt(e,t,n){if(null===n)return;const r=this.overlays.get(n.key);if(null!==r){const e=this.gi.get(r.largestBatchId).delete(n.key);this.gi.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new is(t,n));let s=this.gi.get(t);void 0===s&&(s=xn(),this.gi.set(t,s)),this.gi.set(t,s.add(n.key))}}class Ki{constructor(){this.yi=new wn(Gi.pi),this.Ii=new wn(Gi.Ti)}isEmpty(){return this.yi.isEmpty()}addReference(e,t){const n=new Gi(e,t);this.yi=this.yi.add(n),this.Ii=this.Ii.add(n)}Ei(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ai(new Gi(e,t))}Ri(e,t){e.forEach((e=>this.removeReference(e,t)))}Pi(e){const t=new he(new z([])),n=new Gi(t,e),r=new Gi(t,e+1),s=[];return this.Ii.forEachInRange([n,r],(e=>{this.Ai(e),s.push(e.key)})),s}bi(){this.yi.forEach((e=>this.Ai(e)))}Ai(e){this.yi=this.yi.delete(e),this.Ii=this.Ii.delete(e)}Vi(e){const t=new he(new z([])),n=new Gi(t,e),r=new Gi(t,e+1);let s=xn();return this.Ii.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Gi(e,0),n=this.yi.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Gi{constructor(e,t){this.key=e,this.vi=t}static pi(e,t){return he.comparator(e.key,t.key)||P(e.vi,t.vi)}static Ti(e,t){return P(e.vi,t.vi)||he.comparator(e.key,t.key)}}class $i{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.Bs=[],this.Si=1,this.Di=new wn(Gi.pi)}checkEmpty(e){return jr.resolve(0===this.Bs.length)}addMutationBatch(e,t,n,r){const s=this.Si;this.Si++,this.Bs.length>0&&this.Bs[this.Bs.length-1];const i=new rs(s,t,n,r);this.Bs.push(i);for(const o of r)this.Di=this.Di.add(new Gi(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return jr.resolve(i)}lookupMutationBatch(e,t){return jr.resolve(this.Ci(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.xi(n),s=r<0?0:r;return jr.resolve(this.Bs.length>s?this.Bs[s]:null)}getHighestUnacknowledgedBatchId(){return jr.resolve(0===this.Bs.length?-1:this.Si-1)}getAllMutationBatches(e){return jr.resolve(this.Bs.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Gi(t,0),r=new Gi(t,Number.POSITIVE_INFINITY),s=[];return this.Di.forEachInRange([n,r],(e=>{const t=this.Ci(e.vi);s.push(t)})),jr.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new wn(P);return t.forEach((e=>{const t=new Gi(e,0),r=new Gi(e,Number.POSITIVE_INFINITY);this.Di.forEachInRange([t,r],(e=>{n=n.add(e.vi)}))})),jr.resolve(this.Ni(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;he.isDocumentKey(s)||(s=s.child(""));const i=new Gi(new he(s),0);let o=new wn(P);return this.Di.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.vi)),!0)}),i),jr.resolve(this.Ni(o))}Ni(e){const t=[];return e.forEach((e=>{const n=this.Ci(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){I(0===this.ki(t.batchId,"removed")),this.Bs.shift();let n=this.Di;return jr.forEach(t.mutations,(r=>{const s=new Gi(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.Di=n}))}_n(e){}containsKey(e,t){const n=new Gi(t,0),r=this.Di.firstAfterOrEqual(n);return jr.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.Bs.length,jr.resolve()}ki(e,t){return this.xi(e)}xi(e){return 0===this.Bs.length?0:e-this.Bs[0].batchId}Ci(e){const t=this.xi(e);return t<0||t>=this.Bs.length?null:this.Bs[t]}}class ji{constructor(e){this.Mi=e,this.docs=new gn(he.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Mi(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return jr.resolve(n?n.document.mutableCopy():Re.newInvalidDocument(t))}getEntries(e,t){let n=En();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Re.newInvalidDocument(e))})),jr.resolve(n)}getAllFromCollection(e,t,n){let r=En();const s=new he(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||Ge(Be(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return jr.resolve(r)}getAllFromCollectionGroup(e,t,n,r){v()}Oi(e,t){return jr.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new zi(this)}getSize(e){return jr.resolve(this.size)}}class zi extends ci{constructor(e){super(),this.Kn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.Kn.addEntry(e,r)):this.Kn.removeEntry(n)})),jr.waitFor(t)}getFromCache(e,t){return this.Kn.getEntry(e,t)}getAllFromCache(e,t){return this.Kn.getEntries(e,t)}}class Qi{constructor(e){this.persistence=e,this.Fi=new mn((e=>ze(e)),Qe),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.$i=0,this.Bi=new Ki,this.targetCount=0,this.Li=Xs.gn()}forEachTarget(e,t){return this.Fi.forEach(((e,n)=>t(n))),jr.resolve()}getLastRemoteSnapshotVersion(e){return jr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return jr.resolve(this.$i)}allocateTargetId(e){return this.highestTargetId=this.Li.next(),jr.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.$i&&(this.$i=t),jr.resolve()}Tn(e){this.Fi.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Li=new Xs(t),this.highestTargetId=t),e.sequenceNumber>this.$i&&(this.$i=e.sequenceNumber)}addTargetData(e,t){return this.Tn(t),this.targetCount+=1,jr.resolve()}updateTargetData(e,t){return this.Tn(t),jr.resolve()}removeTargetData(e,t){return this.Fi.delete(t.target),this.Bi.Pi(t.targetId),this.targetCount-=1,jr.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Fi.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Fi.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),jr.waitFor(s).next((()=>r))}getTargetCount(e){return jr.resolve(this.targetCount)}getTargetData(e,t){const n=this.Fi.get(t)||null;return jr.resolve(n)}addMatchingKeys(e,t,n){return this.Bi.Ei(t,n),jr.resolve()}removeMatchingKeys(e,t,n){this.Bi.Ri(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),jr.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Bi.Pi(t),jr.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Bi.Vi(t);return jr.resolve(n)}containsKey(e,t){return jr.resolve(this.Bi.containsKey(t))}}class Wi{constructor(e,t){this.Ui={},this.overlays={},this.es=new R(0),this.ns=!1,this.ns=!0,this.referenceDelegate=e(this),this.fs=new Qi(this),this.indexManager=new Rs,this.ds=function(e){return new ji(e)}((e=>this.referenceDelegate.qi(e))),this.M=new as(t),this._s=new Ui(this.M)}start(){return Promise.resolve()}shutdown(){return this.ns=!1,Promise.resolve()}get started(){return this.ns}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Bi,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Ui[e.toKey()];return n||(n=new $i(t,this.referenceDelegate),this.Ui[e.toKey()]=n),n}getTargetCache(){return this.fs}getRemoteDocumentCache(){return this.ds}getBundleCache(){return this._s}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const r=new Hi(this.es.next());return this.referenceDelegate.Ki(),n(r).next((e=>this.referenceDelegate.Gi(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Qi(e,t){return jr.or(Object.values(this.Ui).map((n=>()=>n.containsKey(e,t))))}}class Hi extends $r{constructor(e){super(),this.currentSequenceNumber=e}}class Yi{constructor(e){this.persistence=e,this.ji=new Ki,this.Wi=null}static zi(e){return new Yi(e)}get Hi(){if(this.Wi)return this.Wi;throw v()}addReference(e,t,n){return this.ji.addReference(n,t),this.Hi.delete(n.toString()),jr.resolve()}removeReference(e,t,n){return this.ji.removeReference(n,t),this.Hi.add(n.toString()),jr.resolve()}markPotentiallyOrphaned(e,t){return this.Hi.add(t.toString()),jr.resolve()}removeTarget(e,t){this.ji.Pi(t.targetId).forEach((e=>this.Hi.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Hi.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ki(){this.Wi=new Set}Gi(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return jr.forEach(this.Hi,(n=>{const r=he.fromPath(n);return this.Ji(e,r).next((e=>{e||t.removeEntry(r,B.min())}))})).next((()=>(this.Wi=null,t.apply(e))))}updateLimboDocument(e,t){return this.Ji(e,t).next((e=>{e?this.Hi.delete(t.toString()):this.Hi.add(t.toString())}))}qi(e){return 0}Ji(e,t){return jr.or([()=>jr.resolve(this.ji.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Qi(e,t)])}}function Xi(e,t){return`firestore_clients_${e}_${t}`}function Ji(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Zi(e,t){return`firestore_targets_${e}_${t}`}class eo{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Yi(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new eo(e,t,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Xi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class to{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Yi(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new to(e,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Xi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class no{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Yi(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=kn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ce(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new no(e,s):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class ro{constructor(e,t){this.clientId=e,this.onlineState=t}static Yi(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ro(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class so{constructor(){this.activeTargetIds=kn()}Zi(e){this.activeTargetIds=this.activeTargetIds.add(e)}tr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Xi(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class io{constructor(e,t,n,r,s){this.window=e,this.Yn=t,this.persistenceKey=n,this.er=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.nr=this.sr.bind(this),this.ir=new gn(P),this.started=!1,this.rr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ur=Xi(this.persistenceKey,this.er),this.ar=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.ir=this.ir.insert(this.er,new so),this.cr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.hr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.lr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.dr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this._r=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.nr)}static vt(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Fs();for(const n of e){if(n===this.er)continue;const e=this.getItem(Xi(this.persistenceKey,n));if(e){const t=no.Yi(n,e);t&&(this.ir=this.ir.insert(t.clientId,t))}}this.wr();const t=this.storage.getItem(this.dr);if(t){const e=this.mr(t);e&&this.gr(e)}for(const n of this.rr)this.sr(n);this.rr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.ar,JSON.stringify(e))}getAllActiveQueryTargets(){return this.yr(this.ir)}isActiveQueryTarget(e){let t=!1;return this.ir.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.pr(e,"pending")}updateMutationState(e,t,n){this.pr(e,t,n),this.Ir(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Zi(this.persistenceKey,e));if(n){const r=to.Yi(e,n);r&&(t=r.state)}}return this.Tr.Zi(e),this.wr(),t}removeLocalQueryTarget(e){this.Tr.tr(e),this.wr()}isLocalQueryTarget(e){return this.Tr.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Zi(this.persistenceKey,e))}updateQueryState(e,t,n){this.Er(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Ir(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Ar(e)}notifyBundleLoaded(e){this.Rr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.nr),this.removeItem(this.ur),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}sr(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.ur)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Yn.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.cr.test(t.key)){if(null==t.newValue){const e=this.Pr(t.key);return this.br(e,null)}{const e=this.Vr(t.key,t.newValue);if(e)return this.br(e.clientId,e)}}else if(this.hr.test(t.key)){if(null!==t.newValue){const e=this.vr(t.key,t.newValue);if(e)return this.Sr(e)}}else if(this.lr.test(t.key)){if(null!==t.newValue){const e=this.Dr(t.key,t.newValue);if(e)return this.Cr(e)}}else if(t.key===this.dr){if(null!==t.newValue){const e=this.mr(t.newValue);if(e)return this.gr(e)}}else if(t.key===this.ar){const e=function(e){let t=R.A;if(null!=e)try{const n=JSON.parse(e);I("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==R.A&&this.sequenceNumberHandler(e)}else if(t.key===this._r){const e=this.Nr(t.newValue);await Promise.all(e.map((e=>this.syncEngine.kr(e))))}}else this.rr.push(t)}))}}get Tr(){return this.ir.get(this.er)}wr(){this.setItem(this.ur,this.Tr.Xi())}pr(e,t,n){const r=new eo(this.currentUser,e,t,n),s=Ji(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Xi())}Ir(e){const t=Ji(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ar(e){const t={clientId:this.er,onlineState:e};this.storage.setItem(this.dr,JSON.stringify(t))}Er(e,t,n){const r=Zi(this.persistenceKey,e),s=new to(e,t,n);this.setItem(r,s.Xi())}Rr(e){const t=JSON.stringify(Array.from(e));this.setItem(this._r,t)}Pr(e){const t=this.cr.exec(e);return t?t[1]:null}Vr(e,t){const n=this.Pr(e);return no.Yi(n,t)}vr(e,t){const n=this.hr.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return eo.Yi(new h(s),r,t)}Dr(e,t){const n=this.lr.exec(e),r=Number(n[1]);return to.Yi(r,t)}mr(e){return ro.Yi(e)}Nr(e){return JSON.parse(e)}async Sr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Mr(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Cr(e){return this.syncEngine.Or(e.targetId,e.state,e.error)}br(e,t){const n=t?this.ir.insert(e,t):this.ir.remove(e),r=this.yr(this.ir),s=this.yr(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.Fr(i,o).then((()=>{this.ir=n}))}gr(e){this.ir.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}yr(e){let t=kn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class oo{constructor(){this.$r=new so,this.Br={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.$r.Zi(e),this.Br[e]||"not-current"}updateQueryState(e,t,n){this.Br[e]=t}removeLocalQueryTarget(e){this.$r.tr(e)}isLocalQueryTarget(e){return this.$r.activeTargetIds.has(e)}clearQueryState(e){delete this.Br[e]}getAllActiveQueryTargets(){return this.$r.activeTargetIds}isActiveQueryTarget(e){return this.$r.activeTargetIds.has(e)}start(){return this.$r=new so,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ao{Lr(e){}shutdown(){}}class uo{constructor(){this.Ur=()=>this.qr(),this.Kr=()=>this.Gr(),this.Qr=[],this.jr()}Lr(e){this.Qr.push(e)}shutdown(){window.removeEventListener("online",this.Ur),window.removeEventListener("offline",this.Kr)}jr(){window.addEventListener("online",this.Ur),window.addEventListener("offline",this.Kr)}qr(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Qr)e(0)}Gr(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Qr)e(1)}static vt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const co={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class ho{constructor(e){this.Wr=e.Wr,this.zr=e.zr}Hr(e){this.Jr=e}Yr(e){this.Xr=e}onMessage(e){this.Zr=e}close(){this.zr()}send(e){this.Wr(e)}eo(){this.Jr()}no(e){this.Xr(e)}so(e){this.Zr(e)}}class lo extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.io=t+"://"+e.host,this.ro="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}oo(e,t,n,r,s){const i=this.uo(e,t);g("RestConnection","Sending: ",i,n);const o={};return this.ao(o,r,s),this.co(e,i,o,n).then((e=>(g("RestConnection","Received: ",e),e)),(t=>{throw y("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}ho(e,t,n,r,s){return this.oo(e,t,n,r,s)}ao(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+l,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}uo(e,t){const n=co[e];return`${this.io}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}co(e,t,n,r){return new Promise(((s,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const t=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(t)),s(t);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+e+'" timed out'),i(new S(T.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const e=o.getResponseJson().error;if(e&&e.status&&e.message){const t=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(T).indexOf(t)>=0?t:T.UNKNOWN}(e.status);i(new S(t,e.message))}else i(new S(T.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(T.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+e+'" completed.')}}));const u=JSON.stringify(r);o.send(t,"POST",u,n,15)}))}lo(e,t,n){const r=[this.io,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=(0,a.UE)(),i=(0,a.FJ)(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(u.xmlHttpFactory=new a.zI({})),this.ao(u.initMessageHeaders,t,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(u.httpHeadersOverwriteParam="$httpHeaders");const c=r.join("");g("Connection","Creating WebChannel: "+c,u);const h=s.createWebChannel(c,u);let l=!1,d=!1;const f=new ho({Wr:e=>{d?g("Connection","Not sending because WebChannel is closed:",e):(l||(g("Connection","Opening WebChannel transport."),h.open(),l=!0),g("Connection","WebChannel sending:",e),h.send(e))},zr:()=>h.close()}),m=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return m(h,a.ii.EventType.OPEN,(()=>{d||g("Connection","WebChannel transport opened.")})),m(h,a.ii.EventType.CLOSE,(()=>{d||(d=!0,g("Connection","WebChannel transport closed"),f.no())})),m(h,a.ii.EventType.ERROR,(e=>{d||(d=!0,y("Connection","WebChannel transport errored:",e),f.no(new S(T.UNAVAILABLE,"The operation could not be completed")))})),m(h,a.ii.EventType.MESSAGE,(e=>{var t;if(!d){const n=e.data[0];I(!!n);const r=n,s=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(s){g("Connection","WebChannel received error:",s);const e=s.status;let t=function(e){const t=hn[e];if(void 0!==t)return fn(t)}(e),n=s.message;void 0===t&&(t=T.INTERNAL,n="Unknown error status: "+e+" with message "+s.message),d=!0,f.no(new S(t,n)),h.close()}else g("Connection","WebChannel received:",n),f.so(n)}})),m(i,a.ju.STAT_EVENT,(e=>{e.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):e.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.eo()}),0),f}}function fo(){return"undefined"!=typeof window?window:null}function mo(){return"undefined"!=typeof document?document:null}function go(e){return new Kn(e,!0)}class po{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Yn=e,this.timerId=t,this.fo=n,this._o=r,this.wo=s,this.mo=0,this.yo=null,this.po=Date.now(),this.reset()}reset(){this.mo=0}Io(){this.mo=this.wo}To(e){this.cancel();const t=Math.floor(this.mo+this.Eo()),n=Math.max(0,Date.now()-this.po),r=Math.max(0,t-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.mo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.yo=this.Yn.enqueueAfterDelay(this.timerId,r,(()=>(this.po=Date.now(),e()))),this.mo*=this._o,this.mo<this.fo&&(this.mo=this.fo),this.mo>this.wo&&(this.mo=this.wo)}Ao(){null!==this.yo&&(this.yo.skipDelay(),this.yo=null)}cancel(){null!==this.yo&&(this.yo.cancel(),this.yo=null)}Eo(){return(Math.random()-.5)*this.mo}}class yo{constructor(e,t,n,r,s,i,o,a){this.Yn=e,this.Ro=n,this.Po=r,this.bo=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Vo=0,this.vo=null,this.So=null,this.stream=null,this.Do=new po(e,t)}Co(){return 1===this.state||5===this.state||this.xo()}xo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.No()}async stop(){this.Co()&&await this.close(0)}ko(){this.state=0,this.Do.reset()}Mo(){this.xo()&&null===this.vo&&(this.vo=this.Yn.enqueueAfterDelay(this.Ro,6e4,(()=>this.Oo())))}Fo(e){this.$o(),this.stream.send(e)}async Oo(){if(this.xo())return this.close(0)}$o(){this.vo&&(this.vo.cancel(),this.vo=null)}Bo(){this.So&&(this.So.cancel(),this.So=null)}async close(e,t){this.$o(),this.Bo(),this.Do.cancel(),this.Vo++,4!==e?this.Do.reset():t&&t.code===T.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.Do.Io()):t&&t.code===T.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Lo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Yr(t)}Lo(){}auth(){this.state=1;const e=this.Uo(this.Vo),t=this.Vo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Vo===t&&this.qo(e,n)}),(t=>{e((()=>{const e=new S(T.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Ko(e)}))}))}qo(e,t){const n=this.Uo(this.Vo);this.stream=this.Go(e,t),this.stream.Hr((()=>{n((()=>(this.state=2,this.So=this.Yn.enqueueAfterDelay(this.Po,1e4,(()=>(this.xo()&&(this.state=3),Promise.resolve()))),this.listener.Hr())))})),this.stream.Yr((e=>{n((()=>this.Ko(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}No(){this.state=5,this.Do.To((async()=>{this.state=0,this.start()}))}Ko(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Uo(e){return t=>{this.Yn.enqueueAndForget((()=>this.Vo===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class wo extends yo{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.M=s}Go(e,t){return this.bo.lo("Listen",e,t)}onMessage(e){this.Do.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.N?(I(void 0===t||"string"==typeof t),X.fromBase64String(t||"")):(I(void 0===t||t instanceof Uint8Array),X.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?T.UNKNOWN:fn(e.code);return new S(t,e.message||"")}(o);n=new Ln(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=Yn(e,r.document.name),i=zn(r.document.updateTime),o=new Me({mapValue:{fields:r.document.fields}}),a=Re.newFoundDocument(s,i,o),u=r.targetIds||[],c=r.removedTargetIds||[];n=new Vn(u,c,a.key,a)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=Yn(e,r.document),i=r.readTime?zn(r.readTime):B.min(),o=Re.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Vn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=Yn(e,r.document),i=r.removedTargetIds||[];n=new Vn([],i,s,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,s=new cn(r),i=e.targetId;n=new Rn(i,s)}}return n}(this.M,e),n=function(e){if(!("targetChange"in e))return B.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?zn(t.readTime):B.min()}(e);return this.listener.Qo(t,n)}jo(e){const t={};t.database=Zn(this.M),t.addTarget=function(e,t){let n;const r=t.target;return n=We(r)?{documents:ir(e,r)}:{query:or(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=$n(e,t.resumeToken):t.snapshotVersion.compareTo(B.min())>0&&(n.readTime=Gn(e,t.snapshotVersion.toTimestamp())),n}(this.M,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.M,e);n&&(t.labels=n),this.Fo(t)}Wo(e){const t={};t.database=Zn(this.M),t.removeTarget=e,this.Fo(t)}}class vo extends yo{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.M=s,this.zo=!1}get Ho(){return this.zo}start(){this.zo=!1,this.lastStreamToken=void 0,super.start()}Lo(){this.zo&&this.Jo([])}Go(e,t){return this.bo.lo("Write",e,t)}onMessage(e){if(I(!!e.streamToken),this.lastStreamToken=e.streamToken,this.zo){this.Do.reset();const t=function(e,t){return e&&e.length>0?(I(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?zn(e.updateTime):zn(t);return n.isEqual(B.min())&&(n=zn(t)),new zt(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=zn(e.commitTime);return this.listener.Yo(n,t)}return I(!e.writeResults||0===e.writeResults.length),this.zo=!0,this.listener.Xo()}Zo(){const e={};e.database=Zn(this.M),this.Fo(e)}Jo(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>rr(this.M,e)))};this.Fo(t)}}class Io extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.bo=n,this.M=r,this.tu=!1}eu(){if(this.tu)throw new S(T.FAILED_PRECONDITION,"The client has already been terminated.")}oo(e,t,n){return this.eu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.bo.oo(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(T.UNKNOWN,e.toString())}))}ho(e,t,n){return this.eu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.bo.ho(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(T.UNKNOWN,e.toString())}))}terminate(){this.tu=!0}}class bo{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.nu=0,this.su=null,this.iu=!0}ru(){0===this.nu&&(this.ou("Unknown"),this.su=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.su=null,this.uu("Backend didn't respond within 10 seconds."),this.ou("Offline"),Promise.resolve()))))}au(e){"Online"===this.state?this.ou("Unknown"):(this.nu++,this.nu>=1&&(this.cu(),this.uu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ou("Offline")))}set(e){this.cu(),this.nu=0,"Online"===e&&(this.iu=!1),this.ou(e)}ou(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}uu(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.iu?(p(t),this.iu=!1):g("OnlineStateTracker",t)}cu(){null!==this.su&&(this.su.cancel(),this.su=null)}}class Eo{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.hu=[],this.lu=new Map,this.fu=new Set,this.du=[],this._u=s,this._u.Lr((e=>{n.enqueueAndForget((async()=>{Co(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=E(e);t.fu.add(4),await So(t),t.wu.set("Unknown"),t.fu.delete(4),await To(t)}(this))}))})),this.wu=new bo(n,r)}}async function To(e){if(Co(e))for(const t of e.du)await t(!0)}async function So(e){for(const t of e.du)await t(!1)}function _o(e,t){const n=E(e);n.lu.has(t.targetId)||(n.lu.set(t.targetId,t),ko(n)?Ao(n):Ho(n).xo()&&No(n,t))}function Do(e,t){const n=E(e),r=Ho(n);n.lu.delete(t),r.xo()&&xo(n,t),0===n.lu.size&&(r.xo()?r.Mo():Co(n)&&n.wu.set("Unknown"))}function No(e,t){e.mu.Z(t.targetId),Ho(e).jo(t)}function xo(e,t){e.mu.Z(t),Ho(e).Wo(t)}function Ao(e){e.mu=new Pn({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Et:t=>e.lu.get(t)||null}),Ho(e).start(),e.wu.ru()}function ko(e){return Co(e)&&!Ho(e).Co()&&e.lu.size>0}function Co(e){return 0===E(e).fu.size}function Mo(e){e.mu=void 0}async function Vo(e){e.lu.forEach(((t,n)=>{No(e,t)}))}async function Ro(e,t){Mo(e),ko(e)?(e.wu.au(t),Ao(e)):e.wu.set("Unknown")}async function Lo(e,t,n){if(e.wu.set("Online"),t instanceof Ln&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.lu.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.lu.delete(r),e.mu.removeTarget(r))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Fo(e,n)}else if(t instanceof Vn?e.mu.ut(t):t instanceof Rn?e.mu._t(t):e.mu.ht(t),!n.isEqual(B.min()))try{const t=await ki(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.mu.yt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.lu.get(r);s&&e.lu.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.lu.get(t);if(!n)return;e.lu.set(t,n.withResumeToken(X.EMPTY_BYTE_STRING,n.snapshotVersion)),xo(e,t);const r=new os(n.target,t,1,n.sequenceNumber);No(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await Fo(e,t)}}async function Fo(e,t,n){if(!Yr(t))throw t;e.fu.add(1),await So(e),e.wu.set("Offline"),n||(n=()=>ki(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e.fu.delete(1),await To(e)}))}function Po(e,t){return t().catch((n=>Fo(e,n,t)))}async function Oo(e){const t=E(e),n=Yo(t);let r=t.hu.length>0?t.hu[t.hu.length-1].batchId:-1;for(;qo(t);)try{const e=await Mi(t.localStore,r);if(null===e){0===t.hu.length&&n.Mo();break}r=e.batchId,Uo(t,e)}catch(e){await Fo(t,e)}Bo(t)&&Ko(t)}function qo(e){return Co(e)&&e.hu.length<10}function Uo(e,t){e.hu.push(t);const n=Yo(e);n.xo()&&n.Ho&&n.Jo(t.mutations)}function Bo(e){return Co(e)&&!Yo(e).Co()&&e.hu.length>0}function Ko(e){Yo(e).start()}async function Go(e){Yo(e).Zo()}async function $o(e){const t=Yo(e);for(const n of e.hu)t.Jo(n.mutations)}async function jo(e,t,n){const r=e.hu.shift(),s=ss.from(r,t,n);await Po(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await Oo(e)}async function zo(e,t){t&&Yo(e).Ho&&await async function(e,t){if(dn(n=t.code)&&n!==T.ABORTED){const n=e.hu.shift();Yo(e).ko(),await Po(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Oo(e)}var n}(e,t),Bo(e)&&Ko(e)}async function Qo(e,t){const n=E(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=Co(n);n.fu.add(3),await So(n),r&&n.wu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.fu.delete(3),await To(n)}async function Wo(e,t){const n=E(e);t?(n.fu.delete(2),await To(n)):t||(n.fu.add(2),await So(n),n.wu.set("Unknown"))}function Ho(e){return e.gu||(e.gu=function(e,t,n){const r=E(e);return r.eu(),new wo(t,r.bo,r.authCredentials,r.appCheckCredentials,r.M,n)}(e.datastore,e.asyncQueue,{Hr:Vo.bind(null,e),Yr:Ro.bind(null,e),Qo:Lo.bind(null,e)}),e.du.push((async t=>{t?(e.gu.ko(),ko(e)?Ao(e):e.wu.set("Unknown")):(await e.gu.stop(),Mo(e))}))),e.gu}function Yo(e){return e.yu||(e.yu=function(e,t,n){const r=E(e);return r.eu(),new vo(t,r.bo,r.authCredentials,r.appCheckCredentials,r.M,n)}(e.datastore,e.asyncQueue,{Hr:Go.bind(null,e),Yr:zo.bind(null,e),Xo:$o.bind(null,e),Yo:jo.bind(null,e)}),e.du.push((async t=>{t?(e.yu.ko(),await Oo(e)):(await e.yu.stop(),e.hu.length>0&&(g("RemoteStore",`Stopping write stream with ${e.hu.length} pending writes`),e.hu=[]))}))),e.yu}class Xo{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new _,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new Xo(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(T.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Jo(e,t){if(p("AsyncQueue",`${t}: ${e}`),Yr(e))return new S(T.UNAVAILABLE,`${t}: ${e}`);throw e}class Zo{constructor(e){this.comparator=e?(t,n)=>e(t,n)||he.comparator(t.key,n.key):(e,t)=>he.comparator(e.key,t.key),this.keyedMap=Sn(),this.sortedSet=new gn(this.comparator)}static emptySet(e){return new Zo(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Zo))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Zo;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ea{constructor(){this.pu=new gn(he.comparator)}track(e){const t=e.doc.key,n=this.pu.get(t);n?0!==e.type&&3===n.type?this.pu=this.pu.insert(t,e):3===e.type&&1!==n.type?this.pu=this.pu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.pu=this.pu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.pu=this.pu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.pu=this.pu.remove(t):1===e.type&&2===n.type?this.pu=this.pu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.pu=this.pu.insert(t,{type:2,doc:e.doc}):v():this.pu=this.pu.insert(t,e)}Iu(){const e=[];return this.pu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class ta{constructor(e,t,n,r,s,i,o,a){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new ta(e,t,Zo.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Tt(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class na{constructor(){this.Tu=void 0,this.listeners=[]}}class ra{constructor(){this.queries=new mn((e=>St(e)),Tt),this.onlineState="Unknown",this.Eu=new Set}}async function sa(e,t){const n=E(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new na),s)try{i.Tu=await n.onListen(r)}catch(e){const n=Jo(e,`Initialization of query '${_t(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Au(n.onlineState),i.Tu&&t.Ru(i.Tu)&&ua(n)}async function ia(e,t){const n=E(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function oa(e,t){const n=E(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.Ru(s)&&(r=!0);t.Tu=s}}r&&ua(n)}function aa(e,t,n){const r=E(e),s=r.queries.get(t);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(t)}function ua(e){e.Eu.forEach((e=>{e.next()}))}class ca{constructor(e,t,n){this.query=e,this.Pu=t,this.bu=!1,this.Vu=null,this.onlineState="Unknown",this.options=n||{}}Ru(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new ta(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.bu?this.vu(e)&&(this.Pu.next(e),t=!0):this.Su(e,this.onlineState)&&(this.Du(e),t=!0),this.Vu=e,t}onError(e){this.Pu.error(e)}Au(e){this.onlineState=e;let t=!1;return this.Vu&&!this.bu&&this.Su(this.Vu,e)&&(this.Du(this.Vu),t=!0),t}Su(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Cu||!n)&&(!e.docs.isEmpty()||"Offline"===t)}vu(e){if(e.docChanges.length>0)return!0;const t=this.Vu&&this.Vu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Du(e){e=ta.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.bu=!0,this.Pu.next(e)}}class ha{constructor(e,t){this.payload=e,this.byteLength=t}xu(){return"metadata"in this.payload}}class la{constructor(e){this.M=e}fi(e){return Yn(this.M,e)}di(e){return e.metadata.exists?nr(this.M,e.document,!1):Re.newNoDocument(this.fi(e.metadata.name),this._i(e.metadata.readTime))}_i(e){return zn(e)}}class da{constructor(e,t,n){this.Nu=e,this.localStore=t,this.M=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=fa(e)}ku(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.payload.namedQuery)this.queries.push(e.payload.namedQuery);else if(e.payload.documentMetadata){this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t;const n=z.fromString(e.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Mu(e){const t=new Map,n=new la(this.M);for(const r of e)if(r.metadata.queries){const e=n.fi(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||xn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=E(e);let i=xn(),o=En();for(const c of n){const e=t.fi(c.metadata.name);c.document&&(i=i.add(e));const n=t.di(c);n.setReadTime(t._i(c.metadata.readTime)),o=o.insert(e,n)}const a=s.ui.newChangeBuffer({trackRemovals:!0}),u=await Vi(s,function(e){return bt(mt(z.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Ci(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.fs.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.fs.addMatchingKeys(e,i,u.targetId))).next((()=>s.ci.Gs(e,t))).next((()=>t))))))}(this.localStore,new la(this.M),this.documents,this.Nu.id),t=this.Mu(this.documents);for(const n of this.queries)await qi(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Ou:this.collectionGroups,Fu:e}}}function fa(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class ma{constructor(e){this.key=e}}class ga{constructor(e){this.key=e}}class pa{constructor(e,t){this.query=e,this.$u=t,this.Bu=null,this.current=!1,this.Lu=xn(),this.mutatedKeys=xn(),this.Uu=xt(e),this.qu=new Zo(this.Uu)}get Ku(){return this.$u}Gu(e,t){const n=t?t.Qu:new ea,r=t?t.qu:this.qu;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a=gt(this.query)&&r.size===this.query.limit?r.last():null,u=pt(this.query)&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),h=Dt(this.query,t)?t:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.ju(c,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Uu(h,a)>0||u&&this.Uu(h,u)<0)&&(o=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(h?(i=i.add(h),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),gt(this.query)||pt(this.query))for(;i.size>this.query.limit;){const e=gt(this.query)?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{qu:i,Qu:n,ni:o,mutatedKeys:s}}ju(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.qu;this.qu=e.qu,this.mutatedKeys=e.mutatedKeys;const s=e.Qu.Iu();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.Uu(e.doc,t.doc))),this.Wu(n);const i=t?this.zu():[],o=0===this.Lu.size&&this.current?1:0,a=o!==this.Bu;return this.Bu=o,0!==s.length||a?{snapshot:new ta(this.query,e.qu,r,s,e.mutatedKeys,0===o,a,!1),Hu:i}:{Hu:i}}Au(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({qu:this.qu,Qu:new ea,mutatedKeys:this.mutatedKeys,ni:!1},!1)):{Hu:[]}}Ju(e){return!this.$u.has(e)&&!!this.qu.has(e)&&!this.qu.get(e).hasLocalMutations}Wu(e){e&&(e.addedDocuments.forEach((e=>this.$u=this.$u.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.$u=this.$u.delete(e))),this.current=e.current)}zu(){if(!this.current)return[];const e=this.Lu;this.Lu=xn(),this.qu.forEach((e=>{this.Ju(e.key)&&(this.Lu=this.Lu.add(e.key))}));const t=[];return e.forEach((e=>{this.Lu.has(e)||t.push(new ga(e))})),this.Lu.forEach((n=>{e.has(n)||t.push(new ma(n))})),t}Yu(e){this.$u=e.li,this.Lu=xn();const t=this.Gu(e.documents);return this.applyChanges(t,!0)}Xu(){return ta.fromInitialDocuments(this.query,this.qu,this.mutatedKeys,0===this.Bu)}}class ya{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class wa{constructor(e){this.key=e,this.Zu=!1}}class va{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.ta={},this.ea=new mn((e=>St(e)),Tt),this.na=new Map,this.sa=new Set,this.ia=new gn(he.comparator),this.ra=new Map,this.oa=new Ki,this.ua={},this.aa=new Map,this.ca=Xs.yn(),this.onlineState="Unknown",this.ha=void 0}get isPrimaryClient(){return!0===this.ha}}async function Ia(e,t){const n=za(e);let r,s;const i=n.ea.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Xu();else{const e=await Vi(n.localStore,bt(t));n.isPrimaryClient&&_o(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await ba(n,t,r,"current"===i)}return s}async function ba(e,t,n,r){e.la=(t,n,r)=>async function(e,t,n,r){let s=t.view.Gu(n);s.ni&&(s=await Li(e.localStore,t.query,!1).then((({documents:e})=>t.view.Gu(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return Ma(e,t.targetId,o.Hu),o.snapshot}(e,t,n,r);const s=await Li(e.localStore,t,!0),i=new pa(t,s.li),o=i.Gu(s.documents),a=Mn.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState),u=i.applyChanges(o,e.isPrimaryClient,a);Ma(e,n,u.Hu);const c=new ya(t,n,i);return e.ea.set(t,c),e.na.has(n)?e.na.get(n).push(t):e.na.set(n,[t]),u.snapshot}async function Ea(e,t){const n=E(e),r=n.ea.get(t),s=n.na.get(r.targetId);if(s.length>1)return n.na.set(r.targetId,s.filter((e=>!Tt(e,t)))),void n.ea.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Ri(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Do(n.remoteStore,r.targetId),ka(n,r.targetId)})).catch(ni)):(ka(n,r.targetId),await Ri(n.localStore,r.targetId,!0))}async function Ta(e,t){const n=E(e);try{const e=await function(e,t){const n=E(e),r=t.snapshotVersion;let s=n.ii;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.ui.newChangeBuffer({trackRemovals:!0});s=n.ii;const o=[];t.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.fs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.fs.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?c=c.withResumeToken(X.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.fs.updateTargetData(e,c))}));let a=En();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Ci(e,i,t.documentUpdates).next((e=>{a=e}))),!r.isEqual(B.min())){const t=n.fs.getLastRemoteSnapshotVersion(e).next((t=>n.fs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return jr.waitFor(o).next((()=>i.apply(e))).next((()=>n.ci.Gs(e,a))).next((()=>a))})).then((e=>(n.ii=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.ra.get(t);r&&(I(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.Zu=!0:e.modifiedDocuments.size>0?I(r.Zu):e.removedDocuments.size>0&&(I(r.Zu),r.Zu=!1))})),await La(n,e,t)}catch(e){await ni(e)}}function Sa(e,t,n){const r=E(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ea.forEach(((n,r)=>{const s=r.view.Au(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=E(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.listeners)s.Au(t)&&(r=!0)})),r&&ua(n)}(r.eventManager,t),e.length&&r.ta.Qo(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function _a(e,t,n){const r=E(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.ra.get(t),i=s&&s.key;if(i){let e=new gn(he.comparator);e=e.insert(i,Re.newNoDocument(i,B.min()));const n=xn().add(i),s=new Cn(B.min(),new Map,new wn(P),e,n);await Ta(r,s),r.ia=r.ia.remove(i),r.ra.delete(t),Ra(r)}else await Ri(r.localStore,t,!1).then((()=>ka(r,t,n))).catch(ni)}async function Da(e,t){const n=E(e),r=t.batch.batchId;try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.ui.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=jr.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);I(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.Bs.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.Bs.performConsistencyCheck(e))).next((()=>n.ci.Ks(e,r)))}))}(n.localStore,t);Aa(n,r,null),xa(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await La(n,e)}catch(e){await ni(e)}}async function Na(e,t,n){const r=E(e);try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.Bs.lookupMutationBatch(e,t).next((t=>(I(null!==t),r=t.keys(),n.Bs.removeMutationBatch(e,t)))).next((()=>n.Bs.performConsistencyCheck(e))).next((()=>n.ci.Ks(e,r)))}))}(r.localStore,t);Aa(r,t,n),xa(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await La(r,e)}catch(n){await ni(n)}}function xa(e,t){(e.aa.get(t)||[]).forEach((e=>{e.resolve()})),e.aa.delete(t)}function Aa(e,t,n){const r=E(e);let s=r.ua[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.ua[r.currentUser.toKey()]=s}}function ka(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.na.get(t))e.ea.delete(r),n&&e.ta.fa(r,n);e.na.delete(t),e.isPrimaryClient&&e.oa.Pi(t).forEach((t=>{e.oa.containsKey(t)||Ca(e,t)}))}function Ca(e,t){e.sa.delete(t.path.canonicalString());const n=e.ia.get(t);null!==n&&(Do(e.remoteStore,n),e.ia=e.ia.remove(t),e.ra.delete(n),Ra(e))}function Ma(e,t,n){for(const r of n)r instanceof ma?(e.oa.addReference(r.key,t),Va(e,r)):r instanceof ga?(g("SyncEngine","Document no longer in limbo: "+r.key),e.oa.removeReference(r.key,t),e.oa.containsKey(r.key)||Ca(e,r.key)):v()}function Va(e,t){const n=t.key,r=n.path.canonicalString();e.ia.get(n)||e.sa.has(r)||(g("SyncEngine","New document in limbo: "+n),e.sa.add(r),Ra(e))}function Ra(e){for(;e.sa.size>0&&e.ia.size<e.maxConcurrentLimboResolutions;){const t=e.sa.values().next().value;e.sa.delete(t);const n=new he(z.fromString(t)),r=e.ca.next();e.ra.set(r,new wa(n)),e.ia=e.ia.insert(n,r),_o(e.remoteStore,new os(bt(mt(n.path)),r,2,R.A))}}async function La(e,t,n){const r=E(e),s=[],i=[],o=[];r.ea.isEmpty()||(r.ea.forEach(((e,a)=>{o.push(r.la(a,t,n).then((e=>{if(e){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,e.fromCache?"not-current":"current"),s.push(e);const t=_i.Ys(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.ta.Qo(s),await async function(e,t){const n=E(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>jr.forEach(t,(t=>jr.forEach(t.Hs,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>jr.forEach(t.Js,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!Yr(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.ii.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.ii=n.ii.insert(e,s)}}}(r.localStore,i))}async function Fa(e,t){const n=E(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await Ai(n.localStore,t);n.currentUser=t,function(e,t){e.aa.forEach((e=>{e.forEach((e=>{e.reject(new S(T.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.aa.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await La(n,e.hi)}}function Pa(e,t){const n=E(e),r=n.ra.get(t);if(r&&r.Zu)return xn().add(r.key);{let e=xn();const r=n.na.get(t);if(!r)return e;for(const t of r){const r=n.ea.get(t);e=e.unionWith(r.view.Ku)}return e}}async function Oa(e,t){const n=E(e),r=await Li(n.localStore,t.query,!0),s=t.view.Yu(r);return n.isPrimaryClient&&Ma(n,t.targetId,s.Hu),s}async function qa(e,t){const n=E(e);return Pi(n.localStore,t).then((e=>La(n,e)))}async function Ua(e,t,n,r){const s=E(e),i=await function(e,t){const n=E(e),r=E(n.Bs);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.fn(e,t).next((t=>t?n.ci.Ks(e,t):jr.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await Oo(s.remoteStore):"acknowledged"===n||"rejected"===n?(Aa(s,t,r||null),xa(s,t),function(e,t){E(E(e).Bs)._n(t)}(s.localStore,t)):v(),await La(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Ba(e,t,n){const r=E(e),s=[],i=[];for(const o of t){let e;const t=r.na.get(o);if(t&&0!==t.length){e=await Vi(r.localStore,bt(t[0]));for(const e of t){const t=r.ea.get(e),n=await Oa(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await Fi(r.localStore,o);e=await Vi(r.localStore,t),await ba(r,Ka(t),o,!1)}s.push(e)}return r.ta.Qo(i),s}function Ka(e){return ft(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Ga(e){const t=E(e);return E(E(t.localStore).persistence).Fs()}async function $a(e,t,n,r){const s=E(e);if(s.ha)return void g("SyncEngine","Ignoring unexpected query state notification.");const i=s.na.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Pi(s.localStore,Nt(i[0])),r=Cn.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await La(s,e,r);break}case"rejected":await Ri(s.localStore,t,!0),ka(s,t,r);break;default:v()}}async function ja(e,t,n){const r=za(e);if(r.ha){for(const e of t){if(r.na.has(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await Fi(r.localStore,e),n=await Vi(r.localStore,t);await ba(r,Ka(t),n.targetId,!1),_o(r.remoteStore,n)}for(const e of n)r.na.has(e)&&await Ri(r.localStore,e,!1).then((()=>{Do(r.remoteStore,e),ka(r,e)})).catch(ni)}}function za(e){const t=E(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Ta.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Pa.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=_a.bind(null,t),t.ta.Qo=oa.bind(null,t.eventManager),t.ta.fa=aa.bind(null,t.eventManager),t}function Qa(e){const t=E(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Da.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Na.bind(null,t),t}class Wa{constructor(){this.synchronizeTabs=!1}async initialize(e){this.M=go(e.databaseInfo.databaseId),this.sharedClientState=this._a(e),this.persistence=this.wa(e),await this.persistence.start(),this.gcScheduler=this.ma(e),this.localStore=this.ga(e)}ma(e){return null}ga(e){return xi(this.persistence,new Di,e.initialUser,this.M)}wa(e){return new Wi(Yi.zi,this.M)}_a(e){return new oo}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Ha extends Wa{constructor(e,t,n){super(),this.ya=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ya.initialize(this,e),await Qa(this.ya.syncEngine),await Oo(this.ya.remoteStore),await this.persistence.Ts((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}ga(e){return xi(this.persistence,new Di,e.initialUser,this.M)}ma(e){const t=this.persistence.referenceDelegate.garbageCollector;return new ii(t,e.asyncQueue)}wa(e){const t=Ti(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Gs.withCacheSize(this.cacheSizeBytes):Gs.DEFAULT;return new Ii(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,fo(),mo(),this.M,this.sharedClientState,!!this.forceOwnership)}_a(e){return new oo}}class Ya extends Ha{constructor(e,t){super(e,t,!1),this.ya=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.ya.syncEngine;this.sharedClientState instanceof io&&(this.sharedClientState.syncEngine={Mr:Ua.bind(null,t),Or:$a.bind(null,t),Fr:ja.bind(null,t),Fs:Ga.bind(null,t),kr:qa.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ts((async e=>{await async function(e,t){const n=E(e);if(za(n),Qa(n),!0===t&&!0!==n.ha){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Ba(n,e.toArray());n.ha=!0,await Wo(n.remoteStore,!0);for(const r of t)_o(n.remoteStore,r)}else if(!1===t&&!1!==n.ha){const e=[];let t=Promise.resolve();n.na.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(ka(n,s),Ri(n.localStore,s,!0)))),Do(n.remoteStore,s)})),await t,await Ba(n,e),function(e){const t=E(e);t.ra.forEach(((e,n)=>{Do(t.remoteStore,n)})),t.oa.bi(),t.ra=new Map,t.ia=new gn(he.comparator)}(n),n.ha=!1,await Wo(n.remoteStore,!1)}}(this.ya.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):e||this.gcScheduler.stop())}))}_a(e){const t=fo();if(!io.vt(t))throw new S(T.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Ti(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new io(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Xa{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Sa(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Fa.bind(null,this.syncEngine),await Wo(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ra}createDatastore(e){const t=go(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new lo(r));var r;return function(e,t,n,r){return new Io(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Sa(this.syncEngine,e,0),i=uo.vt()?new uo:new ao,new Eo(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new va(e,t,n,r,s,i);return o&&(a.ha=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=E(e);g("RemoteStore","RemoteStore shutting down."),t.fu.add(5),await So(t),t._u.shutdown(),t.wu.set("Unknown")}(this.remoteStore)}}function Ja(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Za{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.pa(this.observer.next,e)}error(e){this.observer.error?this.pa(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}Ia(){this.muted=!0}pa(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class eu{constructor(e,t){this.Ta=e,this.M=t,this.metadata=new _,this.buffer=new Uint8Array,this.Ea=new TextDecoder("utf-8"),this.Aa().then((e=>{e&&e.xu()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Ta.cancel()}async getMetadata(){return this.metadata.promise}async da(){return await this.getMetadata(),this.Aa()}async Aa(){const e=await this.Ra();if(null===e)return null;const t=this.Ea.decode(e),n=Number(t);isNaN(n)&&this.Pa(`length string (${t}) is not valid number`);const r=await this.ba(n);return new ha(JSON.parse(r),e.length+n)}Va(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async Ra(){for(;this.Va()<0&&!(await this.va()););if(0===this.buffer.length)return null;const e=this.Va();e<0&&this.Pa("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async ba(e){for(;this.buffer.length<e;)await this.va()&&this.Pa("Reached the end of bundle when more is expected.");const t=this.Ea.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Pa(e){throw this.Ta.cancel(),new Error(`Invalid bundle format: ${e}`)}async va(){const e=await this.Ta.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class tu{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(T.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=E(e),r=Zn(n.M)+"/documents",s={documents:t.map((e=>Hn(n.M,e)))},i=await n.ho("BatchGetDocuments",r,s),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){I(!!t.found),t.found.name,t.found.updateTime;const n=Yn(e,t.found.name),r=zn(t.found.updateTime),s=new Me({mapValue:{fields:t.found.fields}});return Re.newFoundDocument(n,r,s)}(e,t):"missing"in t?function(e,t){I(!!t.missing),I(!!t.readTime);const n=Yn(e,t.missing),r=zn(t.readTime);return Re.newNoDocument(n,r)}(e,t):v()}(n.M,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());I(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new an(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=he.fromPath(t);this.mutations.push(new un(n,this.precondition(n)))})),await async function(e,t){const n=E(e),r=Zn(n.M)+"/documents",s={writes:t.map((e=>rr(n.M,e)))};await n.oo("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=B.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(T.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?Qt.updateTime(t):Qt.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(B.min()))throw new S(T.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Qt.updateTime(t)}return Qt.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class nu{constructor(e,t,n,r){this.asyncQueue=e,this.datastore=t,this.updateFunction=n,this.deferred=r,this.Sa=5,this.Do=new po(this.asyncQueue,"transaction_retry")}run(){this.Sa-=1,this.Da()}Da(){this.Do.To((async()=>{const e=new tu(this.datastore),t=this.Ca(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.xa(e)}))))})).catch((e=>{this.xa(e)}))}))}Ca(e){try{const t=this.updateFunction(e);return!ae(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}xa(e){this.Sa>0&&this.Na(e)?(this.Sa-=1,this.asyncQueue.enqueueAndForget((()=>(this.Da(),Promise.resolve())))):this.deferred.reject(e)}Na(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||!dn(t)}return!1}}class ru{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=h.UNAUTHENTICATED,this.clientId=F.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(T.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new _;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Jo(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function su(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Ai(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function iu(e,t){e.asyncQueue.verifyOperationInProgress();const n=await ou(e);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>Qo(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Qo(t.remoteStore,n))),e.onlineComponents=t}async function ou(e){return e.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await su(e,new Wa)),e.offlineComponents}async function au(e){return e.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await iu(e,new Xa)),e.onlineComponents}function uu(e){return ou(e).then((e=>e.persistence))}function cu(e){return ou(e).then((e=>e.localStore))}function hu(e){return au(e).then((e=>e.remoteStore))}function lu(e){return au(e).then((e=>e.syncEngine))}async function du(e){const t=await au(e),n=t.eventManager;return n.onListen=Ia.bind(null,t.syncEngine),n.onUnlisten=Ea.bind(null,t.syncEngine),n}function fu(e,t,n={}){const r=new _;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Za({next:i=>{t.enqueueAndForget((()=>ia(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(T.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(T.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new ca(mt(n.path),i,{includeMetadataChanges:!0,Cu:!0});return sa(e,o)}(await du(e),e.asyncQueue,t,n,r))),r.promise}function mu(e,t,n={}){const r=new _;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Za({next:n=>{t.enqueueAndForget((()=>ia(e,o))),n.fromCache&&"server"===r.source?s.reject(new S(T.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new ca(n,i,{includeMetadataChanges:!0,Cu:!0});return sa(e,o)}(await du(e),e.asyncQueue,t,n,r))),r.promise}function gu(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?(new TextEncoder).encode(e):e,function(e,t){return new eu(e,t)}(function(e,t){if(e instanceof Uint8Array)return Ja(e,t);if(e instanceof ArrayBuffer)return Ja(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,go(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=E(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=E(e),r=zn(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n._s.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(fa(r));const s=new da(r,e.localStore,t.M);let i=await t.da();for(;i;){const e=await s.ku(i);e&&n._updateProgress(e),i=await t.da()}const o=await s.complete();return await La(e,o.Fu,void 0),await function(e,t){const n=E(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n._s.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Ou)}catch(e){return y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await lu(e),s,r)}))}const pu=new Map;function yu(e,t,n){if(!n)throw new S(T.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function wu(e,t,n,r){if(!0===t&&!0===r)throw new S(T.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function vu(e){if(!he.isDocumentKey(e))throw new S(T.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Iu(e){if(he.isDocumentKey(e))throw new S(T.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function bu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function Eu(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(T.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=bu(e);throw new S(T.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function Tu(e,t){if(t<=0)throw new S(T.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Su{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new S(T.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(T.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,wu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class _u{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Su({}),this._settingsFrozen=!1,e instanceof oe?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(T.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new oe(e.options.projectId)}(e))}get app(){if(!this._app)throw new S(T.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(T.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Su(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new N;switch(e.type){case"gapi":const t=e.client;return I(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new C(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new S(T.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=pu.get(e);t&&(g("ComponentProvider","Removing Datastore"),pu.delete(e),t.terminate())}(this),Promise.resolve()}}function Du(e,t,n,r={}){var s;const i=(e=Eu(e,_u))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${n}`,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=h.MOCK_USER;else{t=(0,o.Sg)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(T.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new h(i)}e._authCredentials=new x(new D(t,n))}}class Nu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Au(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Nu(this.firestore,e,this._key)}}class xu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new xu(this.firestore,e,this._query)}}class Au extends xu{constructor(e,t,n){super(e,t,mt(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Nu(this.firestore,null,new he(e))}withConverter(e){return new Au(this.firestore,e,this._path)}}function ku(e,t,...n){if(e=(0,o.m9)(e),yu("collection","path",t),e instanceof _u){const r=z.fromString(t,...n);return Iu(r),new Au(e,null,r)}{if(!(e instanceof Nu||e instanceof Au))throw new S(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(z.fromString(t,...n));return Iu(r),new Au(e.firestore,null,r)}}function Cu(e,t){if(e=Eu(e,_u),yu("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(T.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new xu(e,null,function(e){return new dt(z.emptyPath(),e)}(t))}function Mu(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=F.R()),yu("doc","path",t),e instanceof _u){const r=z.fromString(t,...n);return vu(r),new Nu(e,null,new he(r))}{if(!(e instanceof Nu||e instanceof Au))throw new S(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(z.fromString(t,...n));return vu(r),new Nu(e.firestore,e instanceof Au?e.converter:null,new he(r))}}function Vu(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof Nu||e instanceof Au)&&(t instanceof Nu||t instanceof Au)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Ru(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof xu&&t instanceof xu&&e.firestore===t.firestore&&Tt(e._query,t._query)&&e.converter===t.converter}class Lu{constructor(){this.ka=Promise.resolve(),this.Ma=[],this.Oa=!1,this.Fa=[],this.$a=null,this.Ba=!1,this.La=!1,this.Ua=[],this.Do=new po(this,"async_queue_retry"),this.qa=()=>{const e=mo();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Do.Ao()};const e=mo();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.qa)}get isShuttingDown(){return this.Oa}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Ka(),this.Ga(e)}enterRestrictedMode(e){if(!this.Oa){this.Oa=!0,this.La=e||!1;const t=mo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.qa)}}enqueue(e){if(this.Ka(),this.Oa)return new Promise((()=>{}));const t=new _;return this.Ga((()=>this.Oa&&this.La?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Ma.push(e),this.Qa())))}async Qa(){if(0!==this.Ma.length){try{await this.Ma[0](),this.Ma.shift(),this.Do.reset()}catch(e){if(!Yr(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.Ma.length>0&&this.Do.To((()=>this.Qa()))}}Ga(e){const t=this.ka.then((()=>(this.Ba=!0,e().catch((e=>{this.$a=e,this.Ba=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw p("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Ba=!1,e))))));return this.ka=t,t}enqueueAfterDelay(e,t,n){this.Ka(),this.Ua.indexOf(e)>-1&&(t=0);const r=Xo.createAndSchedule(this,e,t,n,(e=>this.ja(e)));return this.Fa.push(r),r}Ka(){this.$a&&v()}verifyOperationInProgress(){}async Wa(){let e;do{e=this.ka,await e}while(e!==this.ka)}za(e){for(const t of this.Fa)if(t.timerId===e)return!0;return!1}Ha(e){return this.Wa().then((()=>{this.Fa.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.Fa)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Wa()}))}Ja(e){this.Ua.push(e)}ja(e){const t=this.Fa.indexOf(e);this.Fa.splice(t,1)}}function Fu(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(e)}class Pu{constructor(){this._progressObserver={},this._taskCompletionResolver=new _,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const Ou=-1;class qu extends _u{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Lu,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Bu(this),this._firestoreClient.terminate()}}function Uu(e){return e._firestoreClient||Bu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Bu(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new ie(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new ru(e._authCredentials,e._appCheckCredentials,e._queue,r)}function Ku(e,t){Xu(e=Eu(e,qu));const n=Uu(e),r=e._freezeSettings(),s=new Xa;return $u(n,s,new Ha(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Gu(e){Xu(e=Eu(e,qu));const t=Uu(e),n=e._freezeSettings(),r=new Xa;return $u(t,r,new Ya(r,n.cacheSizeBytes))}function $u(e,t,n){const r=new _;return e.asyncQueue.enqueue((async()=>{try{await su(e,n),await iu(e,t),r.resolve()}catch(e){if(!function(e){return"FirebaseError"===e.name?e.code===T.FAILED_PRECONDITION||e.code===T.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(e))throw e;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),r.reject(e)}})).then((()=>r.promise))}function ju(e){if(e._initialized&&!e._terminated)throw new S(T.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new _;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!Qr.vt())return Promise.resolve();const t=e+"main";await Qr.delete(t)}(Ti(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function zu(e){return function(e){const t=new _;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=E(e);Co(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=E(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.Bs.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.aa.get(e)||[];r.push(t),n.aa.set(e,r)}catch(e){const n=Jo(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await lu(e),t))),t.promise}(Uu(e=Eu(e,qu)))}function Qu(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await uu(e),n=await hu(e);return t.setNetworkEnabled(!0),function(e){const t=E(e);return t.fu.delete(0),To(t)}(n)}))}(Uu(e=Eu(e,qu)))}function Wu(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await uu(e),n=await hu(e);return t.setNetworkEnabled(!1),async function(e){const t=E(e);t.fu.add(0),await So(t),t.wu.set("Offline")}(n)}))}(Uu(e=Eu(e,qu)))}function Hu(e,t){const n=Uu(e=Eu(e,qu)),r=new Pu;return gu(n,e._databaseId,t,r),r}function Yu(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=E(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n._s.getNamedQuery(e,t)))}(await cu(e),t)))}(Uu(e=Eu(e,qu)),t).then((t=>t?new xu(e,null,t.query):null))}function Xu(e){if(e._initialized||e._terminated)throw new S(T.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Ju{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(T.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Zu{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Zu(X.fromBase64String(e))}catch(e){throw new S(T.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Zu(X.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class ec{constructor(e){this._methodName=e}}class tc{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(T.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(T.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return P(this._lat,e._lat)||P(this._long,e._long)}}const nc=/^__.*__$/;class rc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new nn(e,this.data,this.fieldMask,t,this.fieldTransforms):new tn(e,this.data,t,this.fieldTransforms)}}class sc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new nn(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function ic(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class oc{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.M=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Ya(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Xa(){return this.settings.Xa}Za(e){return new oc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.M,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}tc(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Za({path:n,ec:!1});return r.nc(e),r}sc(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Za({path:n,ec:!1});return r.Ya(),r}ic(e){return this.Za({path:void 0,ec:!0})}rc(e){return Dc(e,this.settings.methodName,this.settings.oc||!1,this.path,this.settings.uc)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}Ya(){if(this.path)for(let e=0;e<this.path.length;e++)this.nc(this.path.get(e))}nc(e){if(0===e.length)throw this.rc("Document fields must not be empty");if(ic(this.Xa)&&nc.test(e))throw this.rc('Document fields cannot begin and end with "__"')}}class ac{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.M=n||go(e)}ac(e,t,n,r=!1){return new oc({Xa:e,methodName:t,uc:n,path:W.emptyPath(),ec:!1,oc:r},this.databaseId,this.M,this.ignoreUndefinedProperties)}}function uc(e){const t=e._freezeSettings(),n=go(e._databaseId);return new ac(e._databaseId,!!t.ignoreUndefinedProperties,n)}function cc(e,t,n,r,s,i={}){const o=e.ac(i.merge||i.mergeFields?2:0,t,n,s);Ec("Data must be an object, but it was:",o,r);const a=Ic(r,o);let u,c;if(i.merge)u=new H(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Tc(t,r,n);if(!o.contains(s))throw new S(T.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Nc(e,s)||e.push(s)}u=new H(e),c=o.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=o.fieldTransforms;return new rc(new Me(a),u,c)}class hc extends ec{_toFieldTransform(e){if(2!==e.Xa)throw 1===e.Xa?e.rc(`${this._methodName}() can only appear at the top level of your update data`):e.rc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof hc}}function lc(e,t,n){return new oc({Xa:3,uc:t.settings.uc,methodName:e._methodName,ec:n},t.databaseId,t.M,t.ignoreUndefinedProperties)}class dc extends ec{_toFieldTransform(e){return new jt(e.path,new Pt)}isEqual(e){return e instanceof dc}}class fc extends ec{constructor(e,t){super(e),this.cc=t}_toFieldTransform(e){const t=lc(this,e,!0),n=this.cc.map((e=>vc(e,t))),r=new Ot(n);return new jt(e.path,r)}isEqual(e){return this===e}}class mc extends ec{constructor(e,t){super(e),this.cc=t}_toFieldTransform(e){const t=lc(this,e,!0),n=this.cc.map((e=>vc(e,t))),r=new Ut(n);return new jt(e.path,r)}isEqual(e){return this===e}}class gc extends ec{constructor(e,t){super(e),this.hc=t}_toFieldTransform(e){const t=new Kt(e.M,Mt(e.M,this.hc));return new jt(e.path,t)}isEqual(e){return this===e}}function pc(e,t,n,r){const s=e.ac(1,t,n);Ec("Data must be an object, but it was:",s,r);const i=[],a=Me.empty();G(r,((e,r)=>{const u=_c(t,e,n);r=(0,o.m9)(r);const c=s.sc(u);if(r instanceof hc)i.push(u);else{const e=vc(r,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new H(i);return new sc(a,u,s.fieldTransforms)}function yc(e,t,n,r,s,i){const a=e.ac(1,t,n),u=[Tc(t,r,n)],c=[s];if(i.length%2!=0)throw new S(T.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)u.push(Tc(t,i[o])),c.push(i[o+1]);const h=[],l=Me.empty();for(let f=u.length-1;f>=0;--f)if(!Nc(h,u[f])){const e=u[f];let t=c[f];t=(0,o.m9)(t);const n=a.sc(e);if(t instanceof hc)h.push(e);else{const r=vc(t,n);null!=r&&(h.push(e),l.set(e,r))}}const d=new H(h);return new sc(l,d,a.fieldTransforms)}function wc(e,t,n,r=!1){return vc(n,e.ac(r?4:3,t))}function vc(e,t){if(bc(e=(0,o.m9)(e)))return Ec("Unsupported field value:",t,e),Ic(e,t);if(e instanceof ec)return function(e,t){if(!ic(t.Xa))throw t.rc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.rc(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.ec&&4!==t.Xa)throw t.rc("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=vc(s,t.ic(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Mt(t.M,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=U.fromDate(e);return{timestampValue:Gn(t.M,n)}}if(e instanceof U){const n=new U(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Gn(t.M,n)}}if(e instanceof tc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Zu)return{bytesValue:$n(t.M,e._byteString)};if(e instanceof Nu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.rc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Qn(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.rc(`Unsupported field value: ${bu(e)}`)}(e,t)}function Ic(e,t){const n={};return $(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):G(e,((e,r)=>{const s=vc(r,t.tc(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function bc(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof U||e instanceof tc||e instanceof Zu||e instanceof Nu||e instanceof ec)}function Ec(e,t,n){if(!bc(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=bu(n);throw"an object"===r?t.rc(e+" a custom object"):t.rc(e+" "+r)}}function Tc(e,t,n){if((t=(0,o.m9)(t))instanceof Ju)return t._internalPath;if("string"==typeof t)return _c(e,t);throw Dc("Field path arguments must be of type string or ",e,!1,void 0,n)}const Sc=new RegExp("[~\\*/\\[\\]]");function _c(e,t,n){if(t.search(Sc)>=0)throw Dc(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Ju(...t.split("."))._internalPath}catch(r){throw Dc(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Dc(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new S(T.INVALID_ARGUMENT,a+e+u)}function Nc(e,t){return e.some((e=>e.isEqual(t)))}class xc{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Nu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Ac(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(kc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Ac extends xc{data(){return super.data()}}function kc(e,t){return"string"==typeof t?_c(e,t):t instanceof Ju?t._internalPath:t._delegate._internalPath}class Cc{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Mc extends xc{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Vc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(kc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Vc extends Mc{data(e={}){return super.data(e)}}class Rc{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Cc(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Vc(this._firestore,this._userDataWriter,n.key,n,new Cc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(T.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>({type:"added",doc:new Vc(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Cc(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter),oldIndex:-1,newIndex:t++})))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Vc(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Cc(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Lc(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Lc(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function Fc(e,t){return e instanceof Mc&&t instanceof Mc?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Rc&&t instanceof Rc&&e._firestore===t._firestore&&Ru(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Pc(e){if(pt(e)&&0===e.explicitOrderBy.length)throw new S(T.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Oc{}function qc(e,...t){for(const n of t)e=n._apply(e);return e}class Uc extends Oc{constructor(e,t,n){super(),this.lc=e,this.fc=t,this.dc=n,this.type="where"}_apply(e){const t=uc(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(T.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){th(o,i);const t=[];for(const n of o)t.push(eh(r,e,n));a={arrayValue:{values:t}}}else a=eh(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||th(o,i),a=wc(n,"where",o,"in"===i||"not-in"===i);const u=Je.create(s,i,a);return function(e,t){if(t.S()){const n=wt(e);if(null!==n&&!n.isEqual(t.field))throw new S(T.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${t.field.toString()}'`);const r=yt(e);null!==r&&nh(e,t.field,r)}const n=function(e,t){for(const n of e.filters)if(t.indexOf(n.op)>=0)return n.op;return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(T.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(T.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}(e,u),u}(e._query,0,t,e.firestore._databaseId,this.lc,this.fc,this.dc);return new xu(e.firestore,e.converter,function(e,t){const n=e.filters.concat([t]);return new dt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}function Bc(e,t,n){const r=t,s=kc("where",e);return new Uc(s,r,n)}class Kc extends Oc{constructor(e,t){super(),this.lc=e,this._c=t,this.type="orderBy"}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(T.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(T.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new ut(t,n);return function(e,t){if(null===yt(e)){const n=wt(e);null!==n&&nh(e,n,t.field)}}(e,r),r}(e._query,this.lc,this._c);return new xu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new dt(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Gc(e,t="asc"){const n=t,r=kc("orderBy",e);return new Kc(r,n)}class $c extends Oc{constructor(e,t,n){super(),this.type=e,this.wc=t,this.mc=n}_apply(e){return new xu(e.firestore,e.converter,Et(e._query,this.wc,this.mc))}}function jc(e){return Tu("limit",e),new $c("limit",e,"F")}function zc(e){return Tu("limitToLast",e),new $c("limitToLast",e,"L")}class Qc extends Oc{constructor(e,t,n){super(),this.type=e,this.gc=t,this.yc=n}_apply(e){const t=Zc(e,this.type,this.gc,this.yc);return new xu(e.firestore,e.converter,function(e,t){return new dt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function Wc(...e){return new Qc("startAt",e,!0)}function Hc(...e){return new Qc("startAfter",e,!1)}class Yc extends Oc{constructor(e,t,n){super(),this.type=e,this.gc=t,this.yc=n}_apply(e){const t=Zc(e,this.type,this.gc,this.yc);return new xu(e.firestore,e.converter,function(e,t){return new dt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function Xc(...e){return new Yc("endBefore",e,!1)}function Jc(...e){return new Yc("endAt",e,!0)}function Zc(e,t,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof xc)return function(e,t,n,r,s){if(!r)throw new S(T.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of It(e))if(o.field.isKeyField())i.push(Ie(t,r.key));else{const e=r.data.field(o.field);if(ne(e))throw new S(T.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(T.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new at(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=uc(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new S(T.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let u=0;u<s.length;u++){const i=s[u];if(o[u].field.isKeyField()){if("string"!=typeof i)throw new S(T.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!vt(e)&&-1!==i.indexOf("/"))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(z.fromString(i));if(!he.isDocumentKey(n))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new he(n);a.push(Ie(t,s))}else{const e=wc(n,r,i);a.push(e)}}return new at(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function eh(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(T.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!vt(t)&&-1!==n.indexOf("/"))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(z.fromString(n));if(!he.isDocumentKey(r))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ie(e,new he(r))}if(n instanceof Nu)return Ie(e,n._key);throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${bu(n)}.`)}function th(e,t){if(!Array.isArray(e)||0===e.length)throw new S(T.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new S(T.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function nh(e,t,n){if(!n.isEqual(t))throw new S(T.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class rh{convertValue(e,t="none"){switch(fe(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ee(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(te(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw v()}}convertObject(e,t){const n={};return G(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new tc(ee(e.latitude),ee(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=re(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(se(e));default:return null}}convertTimestamp(e){const t=Z(e);return new U(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=z.fromString(e);I(pr(n));const r=new oe(n.get(1),n.get(3)),s=new he(n.popFirst(5));return r.isEqual(t)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function sh(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class ih extends rh{constructor(e){super(),this.firestore=e}convertBytes(e){return new Zu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Nu(this.firestore,null,t)}}class oh{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=uc(e)}set(e,t,n){this._verifyNotCommitted();const r=ah(e,this._firestore),s=sh(r.converter,t,n),i=cc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Qt.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=ah(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof Ju?yc(this._dataReader,"WriteBatch.update",s._key,t,n,r):pc(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,Qt.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=ah(e,this._firestore);return this._mutations=this._mutations.concat(new an(t._key,Qt.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(T.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function ah(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(T.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}function uh(e){e=Eu(e,Nu);const t=Eu(e.firestore,qu);return fu(Uu(t),e._key).then((n=>Eh(t,e,n)))}class ch extends rh{constructor(e){super(),this.firestore=e}convertBytes(e){return new Zu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Nu(this.firestore,null,t)}}function hh(e){e=Eu(e,Nu);const t=Eu(e.firestore,qu),n=Uu(t),r=new ch(t);return function(e,t){const n=new _;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=E(e);return n.persistence.runTransaction("read document","readonly",(e=>n.ci.Ls(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(T.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=Jo(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await cu(e),t,n))),n.promise}(n,e._key).then((n=>new Mc(t,r,e._key,n,new Cc(null!==n&&n.hasLocalMutations,!0),e.converter)))}function lh(e){e=Eu(e,Nu);const t=Eu(e.firestore,qu);return fu(Uu(t),e._key,{source:"server"}).then((n=>Eh(t,e,n)))}function dh(e){e=Eu(e,xu);const t=Eu(e.firestore,qu),n=Uu(t),r=new ch(t);return Pc(e._query),mu(n,e._query).then((n=>new Rc(t,r,e,n)))}function fh(e){e=Eu(e,xu);const t=Eu(e.firestore,qu),n=Uu(t),r=new ch(t);return function(e,t){const n=new _;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Li(e,t,!0),s=new pa(t,r.li),i=s.Gu(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=Jo(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await cu(e),t,n))),n.promise}(n,e._query).then((n=>new Rc(t,r,e,n)))}function mh(e){e=Eu(e,xu);const t=Eu(e.firestore,qu),n=Uu(t),r=new ch(t);return mu(n,e._query,{source:"server"}).then((n=>new Rc(t,r,e,n)))}function gh(e,t,n){e=Eu(e,Nu);const r=Eu(e.firestore,qu),s=sh(e.converter,t,n);return bh(r,[cc(uc(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,Qt.none())])}function ph(e,t,n,...r){e=Eu(e,Nu);const s=Eu(e.firestore,qu),i=uc(s);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof Ju?yc(i,"updateDoc",e._key,t,n,r):pc(i,"updateDoc",e._key,t),bh(s,[a.toMutation(e._key,Qt.exists(!0))])}function yh(e){return bh(Eu(e.firestore,qu),[new an(e._key,Qt.none())])}function wh(e,t){const n=Eu(e.firestore,qu),r=Mu(e),s=sh(e.converter,t);return bh(n,[cc(uc(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,Qt.exists(!1))]).then((()=>r))}function vh(e,...t){var n,r,s;e=(0,o.m9)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||Fu(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges};if(Fu(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,h,l;if(e instanceof Nu)h=Eu(e.firestore,qu),l=mt(e._key.path),c={next:n=>{t[a]&&t[a](Eh(h,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Eu(e,xu);h=Eu(n.firestore,qu),l=n._query;const r=new ch(h);c={next:e=>{t[a]&&t[a](new Rc(h,r,n,e))},error:t[a+1],complete:t[a+2]},Pc(e._query)}return function(e,t,n,r){const s=new Za(r),i=new ca(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>sa(await du(e),i))),()=>{s.Ia(),e.asyncQueue.enqueueAndForget((async()=>ia(await du(e),i)))}}(Uu(h),l,u,c)}function Ih(e,t){return function(e,t){const n=new Za(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).Eu.add(t),t.next()}(await du(e),n))),()=>{n.Ia(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).Eu.delete(t)}(await du(e),n)))}}(Uu(e=Eu(e,qu)),Fu(t)?t:{next:t})}function bh(e,t){return function(e,t){const n=new _;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Qa(e);try{const e=await function(e,t){const n=E(e),r=U.now(),s=t.reduce(((e,t)=>e.add(t.key)),xn());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>n.ci.Ks(e,s).next((s=>{i=s;const o=[];for(const e of t){const t=Jt(e,i.get(e.key));null!=t&&o.push(new nn(e.key,t,Ve(t.value.mapValue),Qt.exists(!0)))}return n.Bs.addMutationBatch(e,r,o,t)})))).then((e=>(e.applyToLocalDocumentSet(i),{batchId:e.batchId,changes:i})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.ua[e.currentUser.toKey()];r||(r=new gn(P)),r=r.insert(t,n),e.ua[e.currentUser.toKey()]=r}(r,e.batchId,n),await La(r,e.changes),await Oo(r.remoteStore)}catch(e){const t=Jo(e,"Failed to persist write");n.reject(t)}}(await lu(e),t,n))),n.promise}(Uu(e),t)}function Eh(e,t,n){const r=n.docs.get(t._key),s=new ch(e);return new Mc(e,s,t._key,r,new Cc(n.hasPendingWrites,n.fromCache),t.converter)}class Th extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=uc(e)}get(e){const t=ah(e,this._firestore),n=new ih(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const r=e[0];if(r.isFoundDocument())return new xc(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new xc(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const r=ah(e,this._firestore),s=sh(r.converter,t,n),i=cc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=ah(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof Ju?yc(this._dataReader,"Transaction.update",s._key,t,n,r):pc(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=ah(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=ah(e,this._firestore),n=new ch(this._firestore);return super.get(e).then((e=>new Mc(this._firestore,n,t._key,e._document,new Cc(!1,!1),t.converter)))}}function Sh(e,t){return function(e,t){const n=new _;return e.asyncQueue.enqueueAndForget((async()=>{const r=await function(e){return au(e).then((e=>e.datastore))}(e);new nu(e.asyncQueue,r,t,n).run()})),n.promise}(Uu(e=Eu(e,qu)),(n=>t(new Th(e,n))))}function _h(){return new hc("deleteField")}function Dh(){return new dc("serverTimestamp")}function Nh(...e){return new fc("arrayUnion",e)}function xh(...e){return new mc("arrayRemove",e)}function Ah(e){return new gc("increment",e)}!function(e,t=!0){!function(e){l=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((e,{options:n})=>{const r=e.getProvider("app").getImmediate(),s=new qu(r,new A(e.getProvider("auth-internal")),new V(e.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:t},n),s._setSettings(n),s}),"PUBLIC")),(0,r.registerVersion)(c,"3.4.8",e),(0,r.registerVersion)(c,"3.4.8","esm2017")}()}}]);